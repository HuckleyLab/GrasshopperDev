---
title: "Results manuscript Draft"
output:
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(faraway)
library(stringr)
library(foreach)
library(ggplot2)
library(grid)
library(gridExtra)
library(plotrix)
library(nlme)
library(lme4)
library(car)
library(AICcmodavg)
library(lsmeans)
library(reshape2)
library(MASS)
library(sjPlot) #for plot_new
library(tidyverse)
library(knitr)
library(afex)
library(RColorBrewer)

#webshot::install_phantomjs()
library(kableExtra)

source('Functions.R')

####### Input files ##########

#setwd("./data/")

Instars <- read.csv(file = "./data/GrasshopperData_3rdToAdult_SPR16.csv", header = TRUE, stringsAsFactors = FALSE)
str(Instars)


Instars$sex <- ifelse(Instars$sex == "", NA, Instars$sex)

##### Format dates and calculate ages ########

Instars$Date1_Hatch <- as.Date(Instars$Date_Hatch, format = "%m/%d/%Y")
Instars$Date1_1st <- as.Date(Instars$Date_1st, format = "%m/%d/%Y")
Instars$Date1_2nd <- as.Date(Instars$Date_2nd, format = "%m/%d/%Y")
Instars$Date1_3rd <- as.Date(Instars$Date_3rd, format = "%m/%d/%Y")
Instars$Date1_4th <- as.Date(Instars$Date_4th, format = "%m/%d/%Y")
Instars$Date1_5th <- as.Date(Instars$Date_5th, format = "%m/%d/%Y")
Instars$Date1_5th. <- as.Date(Instars$Date_5th., format = "%m/%d/%Y")
Instars$Date1_Adult <- as.Date(Instars$Date_Adult, format = "%m/%d/%Y")
Instars$Date1_Death <- as.Date(Instars$Date_Death, format = "%m/%d/%Y")

Instars$Age_3rd <- Instars$Date1_3rd - Instars$Date1_Hatch
Instars$Age_4th <- Instars$Date1_4th - Instars$Date1_Hatch
Instars$Age_5th <- Instars$Date1_5th - Instars$Date1_Hatch
Instars$Age_Adult <- Instars$Date1_Adult - Instars$Date1_Hatch


#trim out pell data

Instars <- Instars[Instars$Species == "dodg",]


#set factors

Instars$Site <- as.factor(Instars$Site)
Instars$sex <- as.factor(Instars$sex)
Instars$Temp <- as.factor(Instars$Temp)
Instars$Light <- as.factor(Instars$Light)
Instars$Female <- as.factor(Instars$Female)
Instars$Female2 <- as.factor(paste(Instars$Female, Instars$Site, sep = "_")) #this gives each mother her own ID (now differentiating between FY1's across sites)
```

## Results
### Maturation Rate
#### Time to adulthood


```{r, include=FALSE}
nLmer0 <- lmer(as.numeric(Age_Adult) ~ sex * Site * Temp * Light + 
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars)

nLmer1 <- lmer(as.numeric(Age_Adult) ~ sex + Site + Temp + Light + 
                 sex:Site + sex:Temp + sex:Light + Site:Temp + Site:Light + Temp:Light + 
                 Site:Light:Temp +
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars)

nLmer2 <- lmer(as.numeric(Age_Adult) ~ sex + Site + Temp + Light + 
                 sex:Site + sex:Temp + sex:Light + Site:Temp + Site:Light + Temp:Light + 
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars)

nLmer3 <- lmer(as.numeric(Age_Adult) ~ sex + Site + Temp + Light + 
                 Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars)

nLmer4 <- lmer(as.numeric(Age_Adult) ~ Site + Temp + Light + 
                 Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars)

nLmer5 <- lmer(as.numeric(Age_Adult) ~ Site + Temp + Light + 
                 Site:Temp + Site:Light + Temp:Light +
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars)

#aictab(list(nLmer0, nLmer1, nLmer2, nLmer3, nLmer4, nLmer5), modnames = c("nLmer0", "nLmer1", "nLmer2", "nLmer3", "nLmer4", "nLmer5"))

#best is nLmer0
```

For analyses, we used the lmer function from Lme4 library to model the effects of sex, site, temperature regime, and light regime on age of adulthood, assuming a normal distribution. We included the identity of the grasshopper's mother as a random effect. We assessed several models and the preferred model (ΔAICc > 10) included the main effects of all 4 variables, as well as all of their higher order interactions.  

Figure 1
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.dim=c(9,7)}

# New facet label names for sex variable
sex.labs <- c("Female", "Male")
names(sex.labs) <- c("F", "M")

# New facet label names for supp variable
Light.labs <- c("Long day length", "Short day length")
names(Light.labs) <- c("L", "S")
# 
# Temp.labs <- c("High var", "Low var")
# names(Temp.labs) <- c("HV", "LV")

#plot based on individual means
MinSE <- function(x) {mean(x, na.rm = TRUE) - std.error(x, na.rm = TRUE)}
MaxSE <- function(x) {mean(x, na.rm = TRUE) + std.error(x, na.rm = TRUE)}

Give.N <- function(x){
  return(c(y = MaxSE(x)*1.01, label = length(x))) 
}

#drop NA sex
Instars= Instars[which(Instars$sex %in% c("F","M")),]

ggplot(data = Instars, aes(x = Site, y = Age_Adult, color = Temp)) +
#  rory_theme +
  facet_grid(sex~Light, labeller=labeller(sex = sex.labs, Light = Light.labs)) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun.y = mean, geom = "line", size = .5, position = position_dodge(width = .3)) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("Time to adult (d)") + xlab("Site")+scale_color_manual(name="Temperature", labels=c("High var", "Low var"), values = c("#D6604D", "#4393C3")) + scale_x_discrete(labels=c("2195m", "2591m", "3048m"))+ theme(axis.text.x = element_text(angle = 90, vjust = .2, hjust=1))
```
Figure 1 (caption). High temperature variance (color) leads to faster development, and males develop faster than females (rows) across sites (y-axis). Daylength (columns) interacts with temperature to determine development rates. 

Table 1
```{r, echo=FALSE}

Instars_names <- Instars %>% rename(Sex=sex, Temperature=Temp, Photoperiod=Light)

Instars_names$Site <- recode(Instars_names$Site, A1 = "2195m", B1="2591m", C1="3048m")


nLmer0 <- lmer(as.numeric(Age_Adult) ~ Sex * Site * Temperature * Photoperiod +
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars_names)


a <- Anova(nLmer0, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("tabs/tab1.png")

```

We found that grasshoppers developed faster at high temperature variance ($\chi$^2^~1~=66.849, p<.001) and long photoperiod ($\chi$^2^~1~=6.431, p<.05), and males developed faster than females ($\chi$^2^~1~=6.405, p<.05, Table 1). Site alone did not have a significant effect, but grasshoppers from the highest elevation site (3048m) did appear to develop faster except for females in a long photoperiod environment. Long days sped up development for males in environments with high temperature variance, but not for females in those environments. However, long days delayed development for grasshoppers in low temperature variance environments (Table 1, Figure 1, see Table S1 for coefficients and Figures S1-S3 for model plots). 

Supplements

Table S1
```{r, echo=FALSE}
s <- summary(nLmer0)
s <- data.frame(s[["coefficients"]])


s$Significance <- "   "
s$Significance[s$`Pr...t..`<.05] <- "*  "
s$Significance[s$`Pr...t..`<.001] <- "***"
s$`Pr...t..` <- format(s$`Pr...t..`, scientific=TRUE, digits=3)
s$`Pr...t..` <- as.character(s$`Pr...t..`)
s <- s %>% unite(p, c(`Pr...t..`, Significance), sep="")
options(knitr.kable.NA = '')
kable(s, digits=3, col.names=c("Coefficient", "Std. Error", "df", "t", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("tabs/tabs1.png")

```

Fig S4
```{r, echo=FALSE}
#Corresponding supplementary figures (put here for reference -- can move to bottom later)

#plotting marginal effects

# 4 way interaction
plot_model(nLmer0,type="pred",terms=c("Site","Temperature","Photoperiod","Sex"), show.data=FALSE, show.legend=FALSE) #%>% 


#need to make it prettier!

```
Fig S1
```{r, echo=FALSE}
# main effects
p1 <- plot_model(nLmer0, type="pred", terms=c("Sex"), show.data=FALSE)
p2 <- plot_model(nLmer0, type="pred", terms=c("Temperature"), show.data=FALSE)
p3 <- plot_model(nLmer0, type="pred", terms=c("Photoperiod"), show.data=FALSE)
p4 <- plot_model(nLmer0, type="pred", terms=c("Site"), show.data=FALSE) #not significant just taking a look

grid.arrange(p1, p2, p3, p4, nrow=2)
```

Fig S2
```{r, echo=FALSE}
p1 <- plot_model(nLmer0, type="pred", terms=c("Site", "Temperature"), show.data=FALSE)
p2 <- plot_model(nLmer0, type="pred", terms=c("Site", "Photoperiod"), show.data=FALSE)
p3 <- plot_model(nLmer0, type="pred", terms=c("Sex", "Temperature"), show.data=FALSE)
p4 <- plot_model(nLmer0, type="pred", terms=c("Temperature", "Photoperiod"), show.data=FALSE)

grid.arrange(p1, p2, p3, p4, nrow=2)
```

Fig S3
```{r, echo=FALSE}
p1 <- plot_model(nLmer0, type="pred", terms=c("Site", "Temperature", "Sex"), show.data=FALSE)
p2 <- plot_model(nLmer0, type="pred", terms=c("Site", "Photoperiod", "Sex"), show.data=FALSE)
p3 <- plot_model(nLmer0, type="pred", terms=c("Sex", "Temperature", "Photoperiod"), show.data=FALSE)
p4 <- plot_model(nLmer0, type="pred", terms=c("Site", "Temperature", "Photoperiod"), show.data=FALSE)

grid.arrange(p1, p2, p3, p4, nrow=2)
```

#### Time to each instar

```{r, echo=FALSE, include=FALSE}
Instars_Adult <- Instars_names[is.na(Instars_names$Age_Adult) == FALSE,]
Instars_Adult_Long <- melt(Instars_Adult[,c(1:8,50:54)], id.vars = c("Individual", "CCode", "Female", "Female2", "Site", "Species", "Sex", "Temperature", "Photoperiod")) #tracks the time (value) when each individual reached each instar (variable)

#I changed the nesting from what Rory had ((1|Individual/variable/Female2)). lmer gave me an error with that nesting. I referred to this source (particularly this example: leafLength ~ treatment + (1|Bed/Plant/Leaf) + (1|Season)) , but I'm not entirely sure that I'm right. https://ourcodingclub.github.io/tutorials/mixed-models/ 

#Lauren said: variable should be nested within female. 
#I am confused again! Variable definitely needs to go somewhere because value without variable makes very little sense (the time of arrival without the instar at which the grasshopper arrived at that time). Now I'm wondering if variable should be a fixed effect. Like are we interested to know if instar interacts with sex/site/temp/light? Aside from eyeballing the graph, would we know if it did unless we made it a fixed effect?
#I also don't understand why variable should be nested within female. I know it can't be nested within Individual (which is nested within female) because the nesting appears to work the other way (i.e. every individual has just one 3rd instar measurement). Most things I've googled about repeated measurments in mixed models have involved treating time as a fixed effect (I get that here it's stage and not time since time is our y)

#I've left it as I had it before for now and tried to write it up, but we will probably want to revisit this!
 
# Lmer0.1 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod + 
#                     (1|Female2/Individual/variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)  #doesn't run

Lmer0.1 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod + 
                   (1|Female2/Individual)+(1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long) 

Lmer1.1 <- lmer(as.numeric(value) ~ Sex + Site + Temperature + Photoperiod + 
                   Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
                   Site:Photoperiod:Temperature +
                   (1|Female2/Individual) + (1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

Lmer2.1 <- lmer(as.numeric(value) ~ Sex + Site + Temperature + Photoperiod + 
                   Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
                   (1|Female2/Individual)+ (1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

Lmer3.1 <- lmer(as.numeric(value) ~ Sex + Site + Temperature + Photoperiod + 
                   Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
                   (1|Female2/Individual)+ (1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

Lmer4.1 <- lmer(as.numeric(value) ~ Site + Temperature + Photoperiod + 
                   Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
                   (1|Female2/Individual)+ (1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

Lmer5.1 <- lmer(as.numeric(value) ~ Site + Temperature + Photoperiod + 
                   Site:Temperature + Site:Photoperiod + Temperature:Photoperiod +
                   (1|Female2/Individual)+ (1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

#aictab(list(Lmer0.1, Lmer1.1, Lmer2.1, Lmer3.1, Lmer4.1, Lmer5.1), modnames = c("Lmer0.1", "Lmer1.1", "Lmer2.1", "Lmer3.1", "Lmer4.1", "Lmer5.1"))
#I get 4.1 but it's quite close to other models. 0.1 (the most complex) is last! 4.1 is all combinations excluding sex (main effect and all interactions)

#top 3 are close to one another. Most complex (0.1) is last. We decided to still go with 0.1, I think.

```

```{r}
Instars_Adult_Long <- Instars_Adult_Long %>% rename(Instar=variable)

Lmer0.1 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod * Instar + 
                   (1|Female2/Individual), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

Lmer0.2 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod + 
                   (1|Female2/Individual)+(1|Instar), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

Lmer0.3 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod + Instar*Sex + Instar*Site + Instar*Temperature + Instar*Photoperiod + 
                   (1|Female2/Individual), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

Lmer0.4 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod + Instar + 
                   (1|Female2/Individual), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long) #also tried just Instar and it was terrible

aictab(list(Lmer0.1, Lmer0.2, Lmer0.3, Lmer0.4), modnames = c("Lmer0.1", "Lmer1.1", "Lmer2.1", "whatev"))

a <- Anova(Lmer0.1, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("tabs/tabs2.png")
```

```{r}
s <- summary(Lmer0.1)
s <- data.frame(s[["coefficients"]])


s$Significance <- "   "
s$Significance[s$`Pr...t..`<.05] <- "*  "
s$Significance[s$`Pr...t..`<.001] <- "***"
s$`Pr...t..` <- format(s$`Pr...t..`, scientific=TRUE, digits=3)
s$`Pr...t..` <- as.character(s$`Pr...t..`)
s <- s %>% unite(p, c(`Pr...t..`, Significance), sep="")
options(knitr.kable.NA = '')
kable(s, digits=3, col.names=c("Coefficient", "Std. Error", "df", "t", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("tabs/tabs3devinstarcoeff.png")
```


We applied a model with the same interaction terms to determine the age upon arrival at each instar (rather than simply age at adulthood). [NOTE: Check the random effects!] Our random effects were the identity of the individual (since we were measuring the same individual's time to each instar) -- nested within that individual's mother -- and the instar that we were measuring. We tested other models, and the first three models (none of which were the model we chose) were too close to one another in terms of AICc to resolve (ΔAICc<2). Despite the most complex model having less support than others according to the AICc, in this case we selected it in order to be consistent with the choice we made when modeling time to adulthood.


Figure 2
```{r, echo=FALSE, warning=FALSE, message=FALSE}
#silenced a warning... go back and check

levels(Instars_Adult_Long$Instar) <- c("3rd", "4th", "5th", "Adult")
Temp.labs <- c("High temp var", "Low temp var")
names(Temp.labs) <- c("HV", "LV")

ggplot(data = Instars_Adult_Long, aes(x = Instar, y = value, col = Site)) +
  facet_grid(Temperature~Sex+Photoperiod, labeller=labeller(Temperature=Temp.labs, Photoperiod = Light.labs, Sex=sex.labs)) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Instar))), fun.y = mean, geom = "line", size = .5, position = position_dodge(width = .3)) + scale_color_manual(labels=c("2195m", "2591m", "3048m"), values = brewer.pal(n = 8, name = "Blues")[c(8,6,4)]) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("Time (d)") + xlab("Instar")
```
Figure 2 (caption). Effects of sex (columns), daylight(columns), temperature variance (rows), and site (color) appear to be similar for the timing of arrival at each instar. 

Table 2
```{r, echo=FALSE}
#this treats instar as a random effect, which is not what we're doing anymore

#Instars_Adult_Long_names <- Instars_Adult_Long %>% mutate(Sex=sex, Tempvar=Temp, Daylength=Light) #didn't seem to work as I wanted

#Instars_Adult_Long_names$Site <- recode(Instars_Adult_Long_names$Site, A1 = "2195m", B1="2591m", C1="3048m")


#Lmer0.1 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod +                   (1|Female2/Individual)+(1|Instar), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long_names) 


# a <- Anova(Lmer0.1, type=3)
# a$Significance <- "   "
# a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
# a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
# a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
# a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
# a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
# options(knitr.kable.NA = '')
# kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling()
```
[[Probably need to write about this (assuming this is the model we stick with)! Which effects are significant has changed from time to adult. Will try to do later.]]


### Body Mass

```{r, echo=FALSE, warning=FALSE, message=FALSE}

#Analysis
LmerM0 <- lmer(as.numeric(Mass_Adult) ~ sex * Site * Temp * Light + 
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars)

LmerM1 <- lmer(as.numeric(Mass_Adult) ~ sex + Site + Temp + Light + 
                 sex:Site + sex:Temp + sex:Light + Site:Temp + Site:Light + Temp:Light + 
                 Site:Light:Temp +
                 (1|Female2), 
               REML = FALSE, 
               na.action = 'na.omit', data = Instars) #boundary (singular) fit: see ?isSingular

LmerM2 <- lmer(as.numeric(Mass_Adult) ~ sex + Site + Temp + Light + 
                 sex:Site + sex:Temp + sex:Light + Site:Temp + Site:Light + Temp:Light + 
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars)

LmerM3 <- lmer(as.numeric(Mass_Adult) ~ sex + Site + Temp + Light + 
                 Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars) #boundary (singular) fit: see ?isSingular

LmerM4 <- lmer(as.numeric(Mass_Adult) ~ Site + Temp + Light + 
                 Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                 (1|Female2), 
               REML = FALSE, 
               na.action = 'na.omit', data = Instars) #boundary (singular) fit: see ?isSingular

LmerM5 <- lmer(as.numeric(Mass_Adult) ~ Site + Temp + Light + 
                 Site:Temp + Site:Light + Temp:Light +
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars) #boundary (singular) fit: see ?isSingular

#aictab(list(LmerM0, LmerM1, LmerM2, LmerM3, LmerM4, LmerM5), modnames = c("LmerM0", "LmerM1", "LmerM2", "LmerM3", "LmerM4", "LmerM5"))

#M2 is preferred, followed closely by M3 and M1... we decided to go with M0
#(see singular issues for many other models... all but M2 and M0)


```

We once again used the full model, although it did not have the highest AICc, so that we could easily draw comparisons to our development models (age at adult and age at each instar).

Figure 3
```{r, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(data = Instars_names, aes(x = Site, y = as.numeric(Mass_Adult), color = Temperature)) +
#  rory_theme +
  facet_grid(Sex~Photoperiod, labeller=labeller(Sex = sex.labs, Photoperiod = Light.labs)) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun.y = mean, geom = "line", size = .5, position = position_dodge(width = .3)) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("Mass as adult (g)") + xlab("Site")+scale_color_manual(name="Temperature", labels=c("High var", "Low var"), values = c("#D6604D", "#4393C3")) + scale_x_discrete(labels=c("2195m", "2591m", "3048m"))+ theme(axis.text.x = element_text(angle = 90, vjust = .2, hjust=1))
```
Figure 3 (caption). Adult males have smaller body mass (rows). Low temperature variance (color) at higher elevation sites (y-axis) leads to lower mass in females. Photoperiod (columns) has no significant effect.




Table 3
```{r, echo=FALSE}
#Instars_names <- Instars %>% mutate(Sex=sex, Tempvar=Temp, Daylength=Light) #didn't seem to work as I wanted

#Instars_names$Site <- recode(Instars_names$Site, A1 = "2195m", B1="2591m", C1="3048m")

LmerM0 <- lmer(as.numeric(Mass_Adult) ~ Sex * Site * Temperature * Photoperiod + 
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars_names)

a <- Anova(LmerM0, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("tabs/tab2.png")
```
Unsurprisingly, we found that females have a significantly higher adult mass than males ($\chi$^2^~1~=56.295, p<.001, Table 3). At higher elevation sites, low temperature variance leads to significantly lower mass in females ($\chi$^2^~2~=6.020, p<.001). [NOTE: The temp:site trend alone is significant, but I'm not really seeing it for males so I'm confused if/how I should report/discuss this.] (Table 3, Figure 3, see Table S2 for coefficients and Figures S4-S6 for model plots)


Supplements

Table S2
```{r, echo=FALSE}
s <- summary(LmerM0)
s <- data.frame(s[["coefficients"]])


s$Significance <- "   "
s$Significance[s$`Pr...t..`<.05] <- "*  "
s$Significance[s$`Pr...t..`<.001] <- "***"
s$`Pr...t..` <- format(s$`Pr...t..`, scientific=TRUE, digits=3)
s$`Pr...t..` <- as.character(s$`Pr...t..`)
s <- s %>% unite(p, c(`Pr...t..`, Significance), sep="")
options(knitr.kable.NA = '')
kable(s, digits=3, col.names=c("Coefficient", "Std. Error", "df", "t", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("tabs/tabs3.png")
```

Fig S4

Note to self -- discuss sexM:Site3048:TempLV in discussion
```{r, echo=FALSE}


#plotting marginal effects

#3-way interaction
plot_model(LmerM0,type="pred",terms=c("Site", "Temperature","Photoperiod"),show.data=FALSE)

#Not overall significant according to ANOVA table, but is according to coefficient table (comparing 3048m to 2195m)
#might get rid of this plot -- not sure

```
S5
```{r, echo=FALSE}
plot_model(LmerM0,type="pred",terms=c("Site", "Temperature","Sex"),show.data=FALSE)
#possibly this is the only one I'll keep.

#surprised that the second-order temp:site is significant... it seems to really only be due to females. Perhaps I am not the best at parsing this?
```
S6
```{r, echo=FALSE}
plot_model(LmerM0,type="pred",terms=c("Site", "Temperature"),show.data=FALSE)

#is this just showing me the female panel? It looks very similar
```

[NOTE: Still need to do mass by instar... will have that plot and hopefully analysis for tomorrow]

OK let's figure out mass by instar!
```{r, echo=FALSE}
# Instars_Adult <- Instars_names[is.na(Instars_names$Age_Adult) == FALSE,]
# Instars_Adult_Long <- melt(Instars_Adult[,c(1:8,50:54)], id.vars = c("Individual", "CCode", "Female", "Female2", "Site", "Species", "Sex", "Temperature", "Photoperiod")) #tracks the time (value) when each individual reached each instar (variable)
# Instars_Adult_Long %>% rename(Instar=variable)


M_Instars_Adult <- Instars_names[is.na(Instars_names$Mass_Adult) == FALSE,]
M_Instars_Adult_Long <-  melt(M_Instars_Adult[,c(1:8,18,21,24,30,54)], id.vars = c("Individual", "CCode", "Female", "Female2", "Site", "Species", "Sex", "Temperature", "Photoperiod")) #tracks the mass (value) when each individual reached each instar (variable)
M_Instars_Adult_Long <- M_Instars_Adult_Long %>% rename(Instar=variable)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#silenced a warning... go back and check

levels(M_Instars_Adult_Long$Instar) <- c("3rd", "4th", "5th", "Adult")
Temp.labs <- c("High temp var", "Low temp var")
names(Temp.labs) <- c("HV", "LV")

ggplot(data = M_Instars_Adult_Long, aes(x = Instar, y = value, col = Site)) +
  facet_grid(Temperature~Sex+Photoperiod, labeller=labeller(Temperature=Temp.labs, Photoperiod = Light.labs, Sex=sex.labs)) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Instar))), fun.y = mean, geom = "line", size = .5, position = position_dodge(width = .3)) + scale_color_manual(labels=c("2195m", "2591m", "3048m"), values = brewer.pal(n = 8, name = "Blues")[c(8,6,4)]) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("Mass (g)") + xlab("Instar")
```

```{r}
Lmer0.1 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod * Instar + 
                   (1|Female2/Individual), na.action = 'na.omit', REML=FALSE, data = M_Instars_Adult_Long)

Lmer0.2 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod + 
                   (1|Female2/Individual)+(1|Instar), na.action = 'na.omit', REML=FALSE, data = M_Instars_Adult_Long)

Lmer0.3 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod + Instar*Sex + Instar*Site + Instar*Temperature + Instar*Photoperiod + 
                   (1|Female2/Individual), na.action = 'na.omit', REML=FALSE, data = M_Instars_Adult_Long)

Lmer0.4 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod + Instar + 
                   (1|Female2/Individual), na.action = 'na.omit', REML=FALSE, data = M_Instars_Adult_Long) 

Lmer0.5 <- lmer(as.numeric(value) ~ Instar + (1|Female2/Individual), na.action = 'na.omit', REML=FALSE, data = M_Instars_Adult_Long)


aictab(list(Lmer0.1, Lmer0.2, Lmer0.3, Lmer0.4, Lmer0.5), modnames = c("Lmer0.1", "Lmer0.2", "Lmer0.3", "Lmer0.4", "Lmer0.5"))

#best was 0.3, which includes instar and second-order instar interactions

a <- Anova(Lmer0.3, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("tabs/tabsmassinstaranova.png")
```

```{r}
a <- Anova(Lmer0.1, type=3) #.1 is the full one.... the delta AIC is 48, so I didn't use it, but just to see it
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling()
```


```{r}
s <- summary(Lmer0.3)
s <- data.frame(s[["coefficients"]])


s$Significance <- "   "
s$Significance[s$`Pr...t..`<.05] <- "*  "
s$Significance[s$`Pr...t..`<.001] <- "***"
s$`Pr...t..` <- format(s$`Pr...t..`, scientific=TRUE, digits=3)
s$`Pr...t..` <- as.character(s$`Pr...t..`)
s <- s %>% unite(p, c(`Pr...t..`, Significance), sep="")
options(knitr.kable.NA = '')
kable(s, digits=3, col.names=c("Coefficient", "Std. Error", "df", "t", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("tabs/tabsmassinstarsummary.png")
```

```{r}
plot_model(Lmer0.3, type="pred", terms=c("Instar", "Temperature"), show.data=FALSE)
plot_model(Lmer0.3, type="pred", terms=c("Instar", "Sex"), show.data=FALSE)
plot_model(Lmer0.3, type="pred", terms=c("Instar", "Site"), show.data=FALSE)
```

Body shape
```{r}
AdultsOnly <- Instars_names[is.na(Instars_names$Femur_Adult) == FALSE, ]
AdultsOnly <- AdultsOnly[is.na(AdultsOnly$Sex) == FALSE, ]

TS <- paste(AdultsOnly$Temperature, AdultsOnly$Photoperiod, AdultsOnly$Sex, AdultsOnly$Site, sep = "_")

Shape <- cbind(AdultsOnly$Mass_Adult^1/3, AdultsOnly$Femur_Adult, AdultsOnly$Pronotum_Adult)


#run the PCA
pca1 <- prcomp(Shape, scale. = TRUE)  #uses SVD for computations (mean-centered is default), scaled transforms data to unit variance
PC.scores1<-data.frame(pca1$x)

#Calculate means and se of PC1 and PC2 for plotting
PC1_mean <- unlist(tapply(PC.scores1[, "PC1"], TS, mean))
PC2_mean <- unlist(tapply(PC.scores1[, "PC2"], TS, mean))
PC1_se <- unlist(tapply(PC.scores1[, "PC1"], TS, std.err))
PC2_se <- unlist(tapply(PC.scores1[, "PC2"], TS, std.err))
T_L_Sex_Site <- rownames(PC1_mean)  

# Data frame for the means and errors
PCmeans <- data.frame(T_L_Sex_Site, PC1_mean, PC2_mean, PC1_se, PC2_se)
PCLabels <- str_split_fixed(PCmeans[,1], "_", n = 4) #collect Temp and Light treatments
PCmeans$Temp <- PCLabels[,1]
PCmeans$Light <- PCLabels[,2]
PCmeans$Sex <- PCLabels[,3]
PCmeans$Site <- PCLabels[,4]

error_PC1 <- aes(xmax = PC1_mean + (2*PC1_se), xmin= PC1_mean - (2*PC1_se)) #95% CI
error_PC2 <- aes(ymax = PC2_mean + (2*PC2_se), ymin= PC2_mean - (2*PC2_se)) #95% CI

#PC limits
PC1_lim <- max(abs(PC.scores1[,"PC1"]))
PC2_lim <- max(abs(PC.scores1[,"PC2"]))
PC_lim <- max(c(PC1_lim, PC2_lim))

#reduced dataframe for scatterplot
ScatDat <- data.frame(PC.scores1[, "PC1"], PC.scores1[, "PC2"])

#PC plot
ggplot(data = PCmeans, aes(x = PC1_mean, y = PC2_mean, col = Site, shape = Sex)) +
  facet_wrap(~Temp+Light, nrow = 2) +
  rory_theme +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_errorbar(error_PC2, size = 1, width = 0) +
  geom_errorbarh(error_PC1, size = 1, height = 0) +
  geom_point(size = 8) +
  xlab("PC1") + ylab("PC2") +
  ylim(-PC_lim, PC_lim) + xlim(-PC_lim, PC_lim) +
  #scale_color_manual(values = c(Color1, Color2)) +
  scale_shape_manual(values = c(1, 19)) #+
#scale_fill_manual(values = c(Color1,Color2,"white","white")) +
#geom_point(data = ScatDat, aes(x = PC.scores1...xPC., y = PC.scores1...yPC.), col = colo1, shape = symb1, fill = bg1, size = 4) +
#theme(legend.position = Pos)#
# 


#### multivariate shape analysis ####
# not sure if or how to include a random effect.  For this, leaving female out of it

LmS0 <- lm(cbind(AdultsOnly$Mass_Adult^1/3, AdultsOnly$Femur_Adult, AdultsOnly$Pronotum_Adult) ~ Sex * Site * Temperature * Photoperiod, 
           data = AdultsOnly)

LmS1 <- lm(cbind(AdultsOnly$Mass_Adult^1/3, AdultsOnly$Femur_Adult, AdultsOnly$Pronotum_Adult) ~ Sex + Site + Temperature + Photoperiod + 
             Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
             Site:Photoperiod:Temperature, 
           data = AdultsOnly)

LmS2 <- lm(cbind(AdultsOnly$Mass_Adult^1/3, AdultsOnly$Femur_Adult, AdultsOnly$Pronotum_Adult) ~ Sex + Site + Temperature + Photoperiod + 
             Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod,
           data = AdultsOnly)

LmS3 <- lm(cbind(AdultsOnly$Mass_Adult^1/3, AdultsOnly$Femur_Adult, AdultsOnly$Pronotum_Adult) ~ Sex + Site + Temperature + Photoperiod + 
             Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod, 
           data = AdultsOnly)

LmS4 <- lm(cbind(AdultsOnly$Mass_Adult^1/3, AdultsOnly$Femur_Adult, AdultsOnly$Pronotum_Adult) ~ Site + Temperature + Photoperiod + 
             Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
             Site:Temperature:Photoperiod,
           data = AdultsOnly)

LmS5 <- lm(cbind(AdultsOnly$Mass_Adult^1/3, AdultsOnly$Femur_Adult, AdultsOnly$Pronotum_Adult) ~ Site + Temperature + Photoperiod + 
             Site:Temperature + Site:Photoperiod + Temperature:Photoperiod,
           data = AdultsOnly)

#model selection using p values
anova(LmS5, LmS4, LmS3, LmS2, LmS1, LmS0)

#Anova(LmS0, type = 3) #all interactions are non signficant
#Anova(LmS1, type = 3) #an interaction between sex and temp
#Anova(LmS2, type = 3) #interactions between sex and temp, site and temp (not really... p<.1), site and light (probably a good idea to keep all of the two-way interactions)
#Anova(LmS3, type = 3) #no interactions significant
#Anova(LmS4, type = 3) #no interactions significant
#Anova(LmS5, type = 3) #no interactions signficant
# in all, only the effects of sex and site appear important



#lsmeans(LmS2, pairwise ~ Site|Temp+sex+Light) #A1 and C1 differ from one another in HV_S, LV_L, and LV_S
#lsmeans(LmS2, pairwise ~ Light|Temp+sex+Site) #Light generally has an effect in LV but not HV
#lsmeans(LmS2, pairwise ~ Temp|Light+sex+Site) #Temp regime had an effect under every light and site, with LV always greater than HV
```


```{r}
#BEWARE -- THIS IS SOMEWHAT DIFFERENT FROM RORY'S RESULTS USING Anova(LmS2, type=3)... investigate! -- I'm not sure about type III in general. See Warning here: https://www.rdocumentation.org/packages/car/versions/3.0-10/topics/Anova
f <- manova(LmS2)
a <- as.data.frame(summary(f, test="Pillai")[]$stats)
a$Significance <- "   "
a$Significance[a$`Pr(>F)`<.05] <- "*  "
a$Significance[a$`Pr(>F)`<.001] <- "***"
a$`Pr(>F)` <- format(a$`Pr(>F)`, scientific=TRUE, digits=3)
a$`Pr(>F)` <- as.character(a$`Pr(>F)`)
a <- a %>% unite(p, c(`Pr(>F)`, Significance), sep="")
a[11,6] <- NA
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("Df", "Pillai", "approx F", "num Df", "den Df", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("tabs/shapeanova.png")
```


```{r}
#don't know how to get this into kable, so I'm going to copy and paste into the doc for now
Anova(LmS2, type = 3)
```


### Preferred body temperature

```{r, include=FALSE}
#rm(list=ls(all = TRUE))

library(stringr)
library(foreach)
library(ggplot2)
library(grid)
library(gridExtra)
library(plotrix)

source('Functions.R') #PC, can do via R studio as well

####### Input files ##########

setwd("./data/")

#upload PBT data
PBT <- read.csv(file = "PBTdata_06202016_ALL.csv", header = TRUE, stringsAsFactors = FALSE)

str(PBT)

###### Clean up the data ############

#collect treatment labels
Labels <- str_split_fixed(PBT[,1], "_", n = 4) #collect Temp and Light treatments
PBT$Temp <- Labels[,2]
PBT$Light <- Labels[,3]
PBT$Site <- Labels[,4]

HopRaw <- read.csv(file = "Pdodge_PerformanceData1_06202016_ALL.csv", header = TRUE, stringsAsFactors = FALSE)
SexData <- data.frame(HopRaw$Individual, HopRaw$sex, stringsAsFactors = FALSE)

PBT <- merge(PBT, SexData, by.x =  colnames(PBT)[1], by.y = colnames(SexData)[1])
colnames(PBT)[27] <- "Sex"
PBT$Sex <- ifelse(PBT$Sex == "", NA, PBT$Sex)


#trim out missing data (rows with no values)
PBT <- PBT[is.na(PBT$t_enter_grad) == FALSE, ]

######## calculate median and mean TB for each individual ###############

TB_df <- data.frame(PBT$Tb_1, PBT$Tb_2, PBT$Tb_3, PBT$Tb_4, PBT$Tb_5, PBT$Tb_6)

PBT$Tb_Mean <- apply(TB_df, 1, mean, na.rm = TRUE)
PBT$Tb_Median <- apply(TB_df, 1, median, na.rm = TRUE)
PBT$Tb_sd <- apply(TB_df, 1, sd, na.rm = TRUE)

######## Sample Size ##########

PBT$Treat <- paste(PBT$Temp, PBT$Light, sep = "_")
table(PBT[,c(26,27,31)]) #results collated in google drive file "Performance Sample Sizes"
```

```{r, echo=FALSE}
##### Analyses #####
PBT_2 <- merge(PBT, Instars[,c(1,3,54)], by.x = "Individual", by.y = "Individual")
PBT_Long <- melt(PBT_2[,c(1,3,10,12,14,16,18,20,24:27,31,33)], id.var = c("Individual", "TprefBATCH", "Female2", "Temp", "Light", "Site", "Sex", "Treat"))
PBT_Long$Temp <- as.factor(PBT_Long$Temp)
PBT_Long$Light <- as.factor(PBT_Long$Light)
PBT_Long$Site <- as.factor(PBT_Long$Site)
PBT_Long$Sex <- as.factor(PBT_Long$Sex)
PBT_Long$Individual <- as.factor(PBT_Long$Individual)


hist(PBT_Long$value) #looks quite normal

LmerPBT.0 <- lmer(value ~ Sex * Site * Temp * Light + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long) #initially attempted to include batch and female, but so little variation that the scales were off and the model showed errors

LmerPBT.1 <- lmer(value ~ Sex + Site + Temp + Light + 
                    Sex:Site + Sex:Temp + Sex:Light + Site:Temp + Site:Light + Temp:Light + 
                    Site:Light:Temp +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.2 <- lmer(value ~ Sex + Site + Temp + Light + 
                    Sex:Site + Sex:Temp + Sex:Light + Site:Temp + Site:Light + Temp:Light + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.3 <- lmer(value ~ Sex + Site + Temp + Light + 
                    Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.4 <- lmer(value ~ Site + Temp + Light + 
                    Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.5 <- lmer(value ~ Site + Temp + Light + 
                    Site:Temp + Site:Light + Temp:Light +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.6 <- lmer(value ~ Sex + Site + Temp + Light + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, #this was initially commented out
                  data = PBT_Long)

LmerPBT.7 <- lmer(value ~ Site + Temp + Light + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

aictab(list(LmerPBT.0, LmerPBT.1, LmerPBT.2, LmerPBT.3, LmerPBT.4, LmerPBT.5, LmerPBT.6, LmerPBT.7), modnames = c("LmerPBT.0", "LmerPBT.1", "LmerPBT.2", "LmerPBT.3", "LmerPBT.4", "LmerPBT.5", "LmerPBT.6", "LmerPBT.7"))
#LmerPBT.6 is the preferred model, delta AIC = 7.14 (no interactions)

```

The best model (ΔAICc >5)for preferred body temperature was one of just the main fixed effects (sex, site, temperature regime, and light regime) and the random effect of individual (for repeated measures of the same grasshopper). It makes sense that a relatively simple model was selected given that none of these effects were significant predictors of preferred body temperature.

Figure 4
```{r, echo=FALSE, warning=FALSE, message=FALSE}
#plot based on individual means
MinSE <- function(x) {mean(x, na.rm = TRUE) - std.error(x, na.rm = TRUE)}
MaxSE <- function(x) {mean(x, na.rm = TRUE) + std.error(x, na.rm = TRUE)}

Give.N <- function(x){
  return(c(y = MaxSE(x)*1.01, label = length(x))) 
}


ggplot(data = PBT %>% filter(!is.na(Sex)), aes(x = Site, y = Tb_Mean, color = Temp)) +
#  rory_theme +
  facet_grid(Sex~Light, labeller=labeller(sex = sex.labs, Light = Light.labs)) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun.y = mean, geom = "line", size = .5, position = position_dodge(width = .3)) +
  stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 4) +
  ylab("Mean PBT (C)") + xlab("Site")+scale_color_manual(name="Temp var", labels=c("High var", "Low var"), values = c("#D6604D", "#4393C3")) + scale_x_discrete(labels=c("2195m", "2591m", "3048m"))+ theme(axis.text.x = element_text(angle = 90, vjust = .2, hjust=1))

```
Mean preferred body temperature of lab-reared male and female (rows) grasshoppers whose mothers came from different sites (y-axis). Photoperiod (columns) and temperature variance (rows) were varied. The numbers by the points represent sample sizes.

Table 4
```{r, echo=FALSE}
a <- Anova(LmerPBT.6, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("tabs/tab3.png")
```

None of the main effects were significant. There are arguably nearly significant trends towards low temperature variance and long photoperiod decreasing preferred temperature ($\chi$^2^~1~=3.049, p=.0808; $\chi$^2^~1~=3.120, p=.0773, Table 4)

```{r, include=FALSE}
#I selected the prefered model which did not have these interactions so not sure whether to explore this or not

# lsmeans(LmerPBT.6, pairwise ~ Site|Temp+Light) #Sites never significantly differ from one another
# lsmeans(LmerPBT.6, pairwise ~ Light|Temp) #L and S differ in LV only
# lsmeans(LmerPBT.6, pairwise ~ Temp|Light) #HV and LV differ, only in long days and primarily for C1
```

Supplement
S4
```{r, echo=FALSE}
s <- summary(LmerPBT.6)
kable(s[["coefficients"]], digits=3, format="html") %>% kable_styling() %>% save_kable("tabs/PBTSummary.png")
```



### CTmin and CTmax

QUESTION about the CT data: Sex is not a variable. Was that not recorded / were they all of one sex? 
ANSWER: no -- you must extract it (see what I do now which I got from ThemSens_LB.R)
```{r, echo=FALSE}
CT <- read.csv(file = "./data/CT_Data_2016.csv", header = TRUE)
HopRaw <- read.csv(file = "./data/Pdodge_PerformanceData1_06202016_ALL.csv", header = TRUE, stringsAsFactors = FALSE)
SexData <- data.frame(HopRaw$Individual, HopRaw$sex, stringsAsFactors = FALSE)

CT <- merge(CT, SexData, by.x =  colnames(CT)[1], by.y = colnames(SexData)[1])
colnames(CT)[ncol(CT)] <- "Sex"
CT$Sex <- ifelse(CT$Sex == "", NA, CT$Sex)

#Drop cases with no sex
CT= subset(CT, CT$Sex %in% c("M","F"))
```

```{r}
#exploring CT_max without random effects 

lm_site_max <- lm(as.numeric(CT_max) ~ Site,
                 na.action = 'na.omit', data = CT)

lm_temp_max <- lm(as.numeric(CT_max) ~ Temp,
                 na.action = 'na.omit', data = CT)

lm_light_max <- lm(as.numeric(CT_max) ~ Light,
                 na.action = 'na.omit', data = CT)

lm_sex_max <- lm(as.numeric(CT_max) ~ Sex,
                 na.action = 'na.omit', data = CT) #new

lm_st_max <- lm(as.numeric(CT_max) ~ Site + Temp,
                 na.action = 'na.omit', data = CT)

lm_sl_max <- lm(as.numeric(CT_max) ~ Site + Light,
                 na.action = 'na.omit', data = CT)

lm_tl_max <- lm(as.numeric(CT_max) ~ Temp + Light,
                 na.action = 'na.omit', data = CT)

lm_sS_max <- lm(as.numeric(CT_max) ~ Site + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_tS_max <- lm(as.numeric(CT_max) ~ Temp + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_lS_max <- lm(as.numeric(CT_max) ~ Light + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_sxt_max <- lm(as.numeric(CT_max) ~ Site * Temp,
                 na.action = 'na.omit', data = CT)

lm_sxl_max <- lm(as.numeric(CT_max) ~ Site * Light,
                 na.action = 'na.omit', data = CT)

lm_txl_max <- lm(as.numeric(CT_max) ~ Temp * Light,
                 na.action = 'na.omit', data = CT)

lm_stl_max <- lm(as.numeric(CT_max) ~ Temp + Light + Site,
                 na.action = 'na.omit', data = CT)

lm_stlS_max <- lm(as.numeric(CT_max) ~ Temp + Light + Site + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_sxtxl_max <- lm(as.numeric(CT_max) ~ Temp * Light * Site,
                 na.action = 'na.omit', data = CT)

lm_sxtxlxS_max <- lm(as.numeric(CT_max) ~ Temp * Light * Site * Sex,
                 na.action = 'na.omit', data = CT) #new

aictab(list(lm_site_max, lm_temp_max, lm_light_max, lm_sex_max, lm_st_max, lm_sl_max, lm_tl_max, lm_sS_max, lm_tS_max, lm_lS_max, lm_sxt_max, lm_sxl_max, lm_txl_max, lm_stl_max, lm_stl_max, lm_sxtxl_max, lm_sxtxlxS_max), modnames = c("lm_site_max", "lm_temp_max", "lm_light_max", "lm_sex_max", "lm_st_max", "lm_sl_max", "lm_tl_max", "lm_sS_max", "lm_tS_max", "lm_lS_max", "lm_sxt_max", "lm_sxl_max", "lm_txl_max", "lm_stl_max","lm_stlS_max", "lm_sxtxl_max", "lm_sxtxlxS_max"))
```

```{r}
mod <- lm(as.numeric(CT_max) ~ Sex*Temp*Light*Site, data = CT)
step(mod) #gives Temp + Light

mod <- lm(as.numeric(CT_min) ~ Sex*Temp*Light*Site, data = CT)
step(mod) #gives back something that doesn't have a good AIC (see lm_step in next chunk)
```


```{r}
#exploring CT_min without random effects 

lm_site_min <- lm(as.numeric(CT_min) ~ Site,
                 na.action = 'na.omit', data = CT)

lm_temp_min <- lm(as.numeric(CT_min) ~ Temp,
                 na.action = 'na.omit', data = CT)

lm_light_min <- lm(as.numeric(CT_min) ~ Light,
                 na.action = 'na.omit', data = CT)

lm_sex_min <- lm(as.numeric(CT_min) ~ Sex,
                 na.action = 'na.omit', data = CT) #new

lm_st_min <- lm(as.numeric(CT_min) ~ Site + Temp,
                 na.action = 'na.omit', data = CT)

lm_sl_min <- lm(as.numeric(CT_min) ~ Site + Light,
                 na.action = 'na.omit', data = CT)

lm_tl_min <- lm(as.numeric(CT_min) ~ Temp + Light,
                 na.action = 'na.omit', data = CT)

lm_sS_min <- lm(as.numeric(CT_min) ~ Site + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_tS_min <- lm(as.numeric(CT_min) ~ Temp + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_lS_min <- lm(as.numeric(CT_min) ~ Light + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_sxt_min <- lm(as.numeric(CT_min) ~ Site * Temp,
                 na.action = 'na.omit', data = CT)

lm_sxl_min <- lm(as.numeric(CT_min) ~ Site * Light,
                 na.action = 'na.omit', data = CT)

lm_txl_min <- lm(as.numeric(CT_min) ~ Temp * Light,
                 na.action = 'na.omit', data = CT)

lm_stl_min <- lm(as.numeric(CT_min) ~ Temp + Light + Site,
                 na.action = 'na.omit', data = CT)

lm_stlS_min <- lm(as.numeric(CT_min) ~ Temp + Light + Site + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_sxtxl_min <- lm(as.numeric(CT_min) ~ Temp * Light * Site,
                 na.action = 'na.omit', data = CT)

lm_sxtxlxS_min <- lm(as.numeric(CT_min) ~ Temp * Light * Site * Sex,
                 na.action = 'na.omit', data = CT) #new

lm_step <- lm(as.numeric(CT_min) ~ Sex + Temp + Light + Site + 
    Sex:Temp + Temp:Light + Sex:Site + Temp:Site + Light:Site + 
    Sex:Temp:Site + Temp:Light:Site, data = CT) #this is what the step function gave back

aictab(list(lm_site_min, lm_temp_min, lm_light_min, lm_sex_min, lm_st_min, lm_sl_min, lm_tl_min, lm_sS_min, lm_tS_min, lm_lS_min, lm_sxt_min, lm_sxl_min, lm_txl_min, lm_stl_min, lm_stl_min, lm_sxtxl_min, lm_sxtxlxS_min, lm_step), modnames = c("lm_site_min", "lm_temp_min", "lm_light_min", "lm_sex_min", "lm_st_min", "lm_sl_min", "lm_tl_min", "lm_sS_min", "lm_tS_min", "lm_lS_min", "lm_sxt_min", "lm_sxl_min", "lm_txl_min", "lm_stl_min","lm_stlS_min", "lm_sxtxl_min", "lm_sxtxlxS_min", "lm_step"))
```


```{r, include=FALSE}
CT <- CT %>% mutate(Female=sub("\\..*", "", Individual)) #Individuals only show up in one row. But I'm deducing that the start of the individual's name (before the period) is the mother

#exploring mixed models for CT_max

Lmermax_t <- lmer(as.numeric(CT_max) ~ Temp +
                   (1|Female),
                 REML = FALSE,
                 na.action = 'na.omit', data = CT)
Lmermax_l <- lmer(as.numeric(CT_max) ~ Light +
                   (1|Female),
                 REML = FALSE,
                 na.action = 'na.omit', data = CT)

Lmermax_tl <- lmer(as.numeric(CT_max) ~ Temp + Light +
                   (1|Female),
                 REML = FALSE,
                 na.action = 'na.omit', data = CT)
#singular

Lmermax_txl <- lmer(as.numeric(CT_max) ~ Temp * Light +
                   (1|Female),
                 REML = FALSE,
                 na.action = 'na.omit', data = CT)
#singular

aictab(list(Lmermax_t,Lmermax_l,Lmermax_tl,Lmermax_txl), modnames= c("Lmermax_t","Lmermax_l","Lmermax_tl","Lmermax_txl"))
```

```{r}
#all singular / boundary issues (except just l which is the worst in terms of dAICc (=3.95))

#exploring mixed models for CT_min

Lmermin_t <- lmer(as.numeric(CT_min) ~ Temp +
                   (1|Female),
                 REML = FALSE,
                 na.action = 'na.omit', data = CT)
Lmermin_l <- lmer(as.numeric(CT_min) ~ Light +
                   (1|Female),
                 REML = FALSE,
                 na.action = 'na.omit', data = CT)

Lmermin_tl <- lmer(as.numeric(CT_min) ~ Temp + Light +
                   (1|Female),
                 REML = FALSE,
                 na.action = 'na.omit', data = CT)
#singular

Lmermin_txl <- lmer(as.numeric(CT_min) ~ Temp * Light +
                   (1|Female),
                 REML = FALSE,
                 na.action = 'na.omit', data = CT)
#singular

aictab(list(Lmermin_t,Lmermin_l,Lmermin_tl,Lmermin_txl), modnames= c("Lmermin_t","Lmermin_l","Lmermin_tl","Lmermin_txl"))
```

Ideas: 
-Use Temp*Light for both CTmin and CTmax (since it's within delta AICc of 2 for both and tops for one). 
-Use the better one for each (CTmin is Temp*Light, CTmax is just Light)
-Omit the random effect of the mother and do one of these above 2 options with lm (I should see if I can compare the AICs or otherwise evaluate which is better... aictab doesn't like dealing with the different types)

Follow-up questions: 
-Is it important that CTmax and CTmin use the same model?
-Regardless of what we do, we get a singularity for CTmin if we have the random effect. Is this a huge issue that we have to avoid at all costs?

```{r}
#considering going with txl for both and omitting the random effect
AIC(lm_txl_min, Lmermin_txl)
AIC(lm_txl_max, Lmermax_txl)
#in each case the AIC is lower by 2 when random effects are omitted
```


```{r}
#not sure about whether to do txl or t+l... this would indicate t+l or even simply l... but actually, I think it might not be necessary to go with the same model for both

lm_txl <- lm(cbind(as.numeric(CT_min), as.numeric(CT_max)) ~ Temp * Light,
                 na.action = 'na.omit', data = CT)
lm_tl <- lm(cbind(as.numeric(CT_min), as.numeric(CT_max)) ~ Temp + Light,
                 na.action = 'na.omit', data = CT)
lm_t <- lm(cbind(as.numeric(CT_min), as.numeric(CT_max)) ~ Temp,
                 na.action = 'na.omit', data = CT)
lm_l <- lm(cbind(as.numeric(CT_min), as.numeric(CT_max)) ~ Light,
                 na.action = 'na.omit', data = CT)
anova(lm_t, lm_tl, lm_txl)
anova(lm_l, lm_tl, lm_txl)
```

```{r}
#table for CTmin
a <- Anova(lm_txl_min, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>F)`<.05] <- "*  "
a$Significance[a$`Pr(>F)`<.001] <- "***"
a$`Pr(>F)` <- format(a$`Pr(>F)`, scientific=TRUE, digits=3)
a$`Pr(>F)` <- as.character(a$`Pr(>F)`)
a <- a %>% unite(p, c(`Pr(>F)`, Significance), sep="")
a[5,4] <- NA
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("Sum Sq", "df", "F value", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("CTminanova.png")

#table for CTmax
a <- Anova(lm_txl_max, type=3) #this is not the best model for CTmax, but it's not much lower in AIC
a$Significance <- "   "
a$Significance[a$`Pr(>F)`<.05] <- "*  "
a$Significance[a$`Pr(>F)`<.001] <- "***"
a$`Pr(>F)` <- format(a$`Pr(>F)`, scientific=TRUE, digits=3)
a$`Pr(>F)` <- as.character(a$`Pr(>F)`)
a <- a %>% unite(p, c(`Pr(>F)`, Significance), sep="")
a[5,4] <- NA
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("Sum Sq", "df", "F value", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("CTmaxanova.png")
```

```{r}
#the lowest AIC for CTmax: Light is significant
#table for CTmax
a <- Anova(lm_tl_max, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>F)`<.05] <- "*  "
a$Significance[a$`Pr(>F)`<.001] <- "***"
a$`Pr(>F)` <- format(a$`Pr(>F)`, scientific=TRUE, digits=3)
a$`Pr(>F)` <- as.character(a$`Pr(>F)`)
a <- a %>% unite(p, c(`Pr(>F)`, Significance), sep="")
a[5,4] <- NA
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("Sum Sq", "df", "F value", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("adultanova.png")
```

```{r}
s <- summary(lm_txl_min)
s <- data.frame(s[["coefficients"]])

s$Significance <- "   "
s$Significance[s$`Pr...t..`<.05] <- "*  "
s$Significance[s$`Pr...t..`<.001] <- "***"
s$`Pr...t..` <- format(s$`Pr...t..`, scientific=TRUE, digits=3)
s$`Pr...t..` <- as.character(s$`Pr...t..`)
s <- s %>% unite(p, c(`Pr...t..`, Significance), sep="")
options(knitr.kable.NA = '')
kable(s, digits=3, col.names=c("Coefficient", "Std. Error", "t", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("tabs/CTminSummary.png")



s <- summary(lm_txl_max)
s <- data.frame(s[["coefficients"]])

s$Significance <- "   "
s$Significance[s$`Pr...t..`<.05] <- "*  "
s$Significance[s$`Pr...t..`<.001] <- "***"
s$`Pr...t..` <- format(s$`Pr...t..`, scientific=TRUE, digits=3)
s$`Pr...t..` <- as.character(s$`Pr...t..`)
s <- s %>% unite(p, c(`Pr...t..`, Significance), sep="")
options(knitr.kable.NA = '')
kable(s, digits=3, col.names=c("Coefficient", "Std. Error", "t", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("tabs/CTmaxSummary.png")
```



Stuff from before:
```{r}
#singular fit for CTmin :(


CT <- CT %>% mutate(Female=sub("\\..*", "", Individual)) #Individuals only show up in one row. But I'm deducing that the start of the individual's name (before the period) is the mother
LmerCTmax.4 <- lmer(as.numeric(CT_max) ~ Site + Temp + Light +
                   Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                   (1|Female),
                 REML = FALSE,
                 na.action = 'na.omit', data = CT)

LmerCTmin.4 <- lmer(as.numeric(CT_min) ~ Site + Temp + Light +
                      Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                      (1|Female),
                    REML = FALSE,
                    na.action = 'na.omit', data = CT)
#table for CTmin
a <- Anova(LmerCTmin.4, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("adultanova.png")

#table for CTmin
a <- Anova(LmerCTmax.4, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("adultanova.png")

```


CTmin
```{r}
ggplot(data = CT, aes(x = Site, y = as.numeric(CT_min), color = Temp)) +
facet_grid(Sex~Light, labeller=labeller(Sex = sex.labs, Light = Light.labs)) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun.y = mean, geom = "line", size = .5, position = position_dodge(width = .3)) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("Time to adult (d)") + xlab("Site")+scale_color_manual(name="Temperature", labels=c("High var", "Low var"), values = c("#D6604D", "#4393C3")) + scale_x_discrete(labels=c("2195m", "2591m", "3048m"))+ theme(axis.text.x = element_text(angle = 90, vjust = .2, hjust=1))

```

CTmax
```{r}
ggplot(data = CT, aes(x = Site, y = as.numeric(CT_max), color = Temp)) +
facet_grid(Sex~Light, labeller=labeller(Sex = sex.labs, Light = Light.labs)) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun.y = mean, geom = "line", size = .5, position = position_dodge(width = .3)) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("Time to adult (d)") + xlab("Site")+scale_color_manual(name="Temperature", labels=c("High var", "Low var"), values = c("#D6604D", "#4393C3")) + scale_x_discrete(labels=c("2195m", "2591m", "3048m"))+ theme(axis.text.x = element_text(angle = 90, vjust = .2, hjust=1))
```



Note: missing supplementary materials... will add them in!


