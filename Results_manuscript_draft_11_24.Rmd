---
title: "Results_manuscript_draft_11_24"
output: html_document
---

Sorry -- it's not the neatest

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(faraway)
library(stringr)
library(foreach)
library(ggplot2)
library(grid)
library(gridExtra)
library(plotrix)
library(nlme)
library(lme4)
library(car)
library(AICcmodavg)
library(lsmeans)
library(reshape2)
library(MASS)
library(sjPlot) #for plot_new
library(tidyverse)
library(knitr)
library(afex)

#webshot::install_phantomjs()
library(kableExtra)

source('Functions.R')

####### Input files ##########

#setwd("./data/")

Instars <- read.csv(file = "./data/GrasshopperData_3rdToAdult_SPR16.csv", header = TRUE, stringsAsFactors = FALSE)
str(Instars)


Instars$sex <- ifelse(Instars$sex == "", NA, Instars$sex)

##### Format dates and calculate ages ########

Instars$Date1_Hatch <- as.Date(Instars$Date_Hatch, format = "%m/%d/%Y")
Instars$Date1_1st <- as.Date(Instars$Date_1st, format = "%m/%d/%Y")
Instars$Date1_2nd <- as.Date(Instars$Date_2nd, format = "%m/%d/%Y")
Instars$Date1_3rd <- as.Date(Instars$Date_3rd, format = "%m/%d/%Y")
Instars$Date1_4th <- as.Date(Instars$Date_4th, format = "%m/%d/%Y")
Instars$Date1_5th <- as.Date(Instars$Date_5th, format = "%m/%d/%Y")
Instars$Date1_5th. <- as.Date(Instars$Date_5th., format = "%m/%d/%Y")
Instars$Date1_Adult <- as.Date(Instars$Date_Adult, format = "%m/%d/%Y")
Instars$Date1_Death <- as.Date(Instars$Date_Death, format = "%m/%d/%Y")

Instars$Age_3rd <- Instars$Date1_3rd - Instars$Date1_Hatch
Instars$Age_4th <- Instars$Date1_4th - Instars$Date1_Hatch
Instars$Age_5th <- Instars$Date1_5th - Instars$Date1_Hatch
Instars$Age_Adult <- Instars$Date1_Adult - Instars$Date1_Hatch


#trim out pell data

Instars <- Instars[Instars$Species == "dodg",]


#set factors

Instars$Site <- as.factor(Instars$Site)
Instars$sex <- as.factor(Instars$sex)
Instars$Temp <- as.factor(Instars$Temp)
Instars$Light <- as.factor(Instars$Light)
Instars$Female <- as.factor(Instars$Female)
Instars$Female2 <- as.factor(paste(Instars$Female, Instars$Site, sep = "_")) #this gives each mother her own ID (now differentiating between FY1's across sites)
```

## Results
### Maturation Rate
#### Time to adulthood

For analyses, we used the lmer function from Lme4 library to model the effects of sex, site, temperature regime, and light regime on age of adulthood, assuming a normal distribution. We included the identity of the grasshopper's mother as a random effect. We assessed several models and the preferred model (ΔAICc > 10) included the main effects of all 4 variables, as well as all of their higher order interactions.  

Figure 1
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.dim=c(9,7)}

# New facet label names for sex variable
sex.labs <- c("Female", "Male")
names(sex.labs) <- c("F", "M")

# New facet label names for supp variable
Light.labs <- c("Long daylight", "Short daylight")
names(Light.labs) <- c("L", "S")
# 
# Temp.labs <- c("High var", "Low var")
# names(Temp.labs) <- c("HV", "LV")

#plot based on individual means
MinSE <- function(x) {mean(x, na.rm = TRUE) - std.error(x, na.rm = TRUE)}
MaxSE <- function(x) {mean(x, na.rm = TRUE) + std.error(x, na.rm = TRUE)}

Give.N <- function(x){
  return(c(y = MaxSE(x)*1.01, label = length(x))) 
}

#drop NA sex
Instars= Instars[which(Instars$sex %in% c("F","M")),]

ggplot(data = Instars, aes(x = Site, y = Age_Adult, color = Temp)) +
#  rory_theme +
  facet_grid(sex~Light, labeller=labeller(sex = sex.labs, Light = Light.labs)) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun.y = mean, geom = "line", size = .5, position = position_dodge(width = .3)) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("Time to adult (d)") + xlab("Site")+scale_color_manual(name="Temp var", labels=c("High var", "Low var"), values = c("#D6604D", "#4393C3")) + scale_x_discrete(labels=c("2195m", "2591m", "3048m"))+ theme(axis.text.x = element_text(angle = 90, vjust = .2, hjust=1))
```
Figure 1 (caption). Generally, high temperature variance leads to faster development and males develop faster than females. The effect of long photoperiod varies depending on other factors. For example, at high temperature variance in males, long photoperiod is associated with faster development times, but it generally slows development times at low temperature variance.
High temperature variance (color) leads to faster development and males develop faster than females (rows) across sites. Daylength (columns) interacts with temperature to determine development rates. 

Table 1
```{r, echo=FALSE}

Instars_names <- Instars %>% mutate(Sex=sex, Tempvar=Temp, Daylength=Light)

Instars_names$Site <- recode(Instars_names$Site, A1 = "2195m", B1="2591m", C1="3048m")


nLmer0 <- lmer(as.numeric(Age_Adult) ~ Sex * Site * Tempvar * Daylength +
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars_names)


a <- Anova(nLmer0, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("adultanova.png")

```

We found that grasshoppers developed faster at high temperature variance (X[1,df]=444, p<.001) and long photoperiod (p<.05), and males developed faster than females (p<.05, Table 1). Site alone did not have a significant effect, but grasshoppers from the highest elevation site (3048m) did appear to develop faster except for females in a long photoperiod environment. Long days sped up development for males in environments with high temperature variance, but not for females in those environments. However, long days delayed development for grasshoppers in low temperature variance environments (Table 1, Figure 1, see Table S1 for coefficients and Figure S1 for model plots). 

#### Time to each instar

[Talking about model selection here (sort of)]

```{r, echo=FALSE}
Instars_Adult <- Instars[is.na(Instars$Age_Adult) == FALSE,]
Instars_Adult_Long <- melt(Instars_Adult[,c(1:8,50:54)], id.vars = c("Individual", "CCode", "Female", "Female2", "Site", "Species", "sex", "Temp", "Light")) #tracks the time (value) when each individual reached each instar (variable)

#I changed the nesting from what Rory had ((1|Individual/variable/Female2)). lmer gave me an error with that nesting. I referred to this source (particularly this example: leafLength ~ treatment + (1|Bed/Plant/Leaf) + (1|Season)) , but I'm not entirely sure that I'm right.

#variable should be nested within female
 
# Lmer0.1 <- lmer(as.numeric(value) ~ sex * Site * Temp * Light + 
#                    (1|Female2/Individual/variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long) 

Lmer0.1 <- lmer(as.numeric(value) ~ sex * Site * Temp * Light + 
                   (1|Female2/Individual)+ (1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long) 

Lmer1.1 <- lmer(as.numeric(value) ~ sex + Site + Temp + Light + 
                   sex:Site + sex:Temp + sex:Light + Site:Temp + Site:Light + Temp:Light + 
                   Site:Light:Temp +
                   (1|Female2/Individual) + (1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

Lmer2.1 <- lmer(as.numeric(value) ~ sex + Site + Temp + Light + 
                   sex:Site + sex:Temp + sex:Light + Site:Temp + Site:Light + Temp:Light + 
                   (1|Female2/Individual)+ (1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

Lmer3.1 <- lmer(as.numeric(value) ~ sex + Site + Temp + Light + 
                   Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                   (1|Female2/Individual)+ (1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

Lmer4.1 <- lmer(as.numeric(value) ~ Site + Temp + Light + 
                   Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                   (1|Female2/Individual)+ (1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

Lmer5.1 <- lmer(as.numeric(value) ~ Site + Temp + Light + 
                   Site:Temp + Site:Light + Temp:Light +
                   (1|Female2/Individual)+ (1|variable), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

aictab(list(Lmer0.1, Lmer1.1, Lmer2.1, Lmer3.1, Lmer4.1, Lmer5.1), modnames = c("Lmer0.1", "Lmer1.1", "Lmer2.1", "Lmer3.1", "Lmer4.1", "Lmer5.1"))
#I get 4.1 but it's quite close to other models. 0.1 (the most complex) is last! 4.1 is all combinations excluding sex (main effect and all interactions)

summary(Lmer4.1)
Anova(Lmer4.1)

```


Figure 2
```{r, warning=FALSE, message=FALSE}
#silenced a warning... go back and check

levels(Instars_Adult_Long$variable) <- c("3rd", "4th", "5th", "Adult")
Temp.labs <- c("High temp var", "Low temp var")
names(Temp.labs) <- c("HV", "LV")

ggplot(data = Instars_Adult_Long, aes(x = variable, y = value, col = Site)) +
  facet_grid(Temp~sex+Light, labeller=labeller(Temp=Temp.labs, Light = Light.labs, sex=sex.labs)) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(variable))), fun.y = mean, geom = "line", size = .5, position = position_dodge(width = .3)) + scale_color_manual(labels=c("2195m", "2591m", "3048m"), values = brewer.pal(n = 8, name = "Blues")[c(8,6,4)]) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("Time (d)") + xlab("Instar")
```
Figure 2 (caption). Effects of sex, daylight, temperature variance, and site appear to be similar for the timing of arrival at each instar.

### Body Mass

Discussion of model selection

Figure 3
```{r}
ggplot(data = Instars, aes(x = Site, y = as.numeric(Mass_Adult), color = Temp)) +
#  rory_theme +
  facet_grid(sex~Light, labeller=labeller(sex = sex.labs, Light = Light.labs)) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun.y = mean, geom = "line", size = .5, position = position_dodge(width = .3)) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("Mass as adult (g)") + xlab("Site")+scale_color_manual(name="Temp var", labels=c("High var", "Low var"), values = c("#D6604D", "#4393C3")) + scale_x_discrete(labels=c("2195m", "2591m", "3048m"))+ theme(axis.text.x = element_text(angle = 90, vjust = .2, hjust=1))
```
Figure 3 (caption). Males have smaller body mass. High temperature variance leads to higher mass, especially in females. [OK so the tables say that Temp alone has an effect, but it kind of looks like it’s only in females… is this a poor model?]

```{r, echo=FALSE}
#Analysis
LmerM0 <- lmer(as.numeric(Mass_Adult) ~ sex * Site * Temp * Light + 
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars)

LmerM1 <- lmer(as.numeric(Mass_Adult) ~ sex + Site + Temp + Light + 
                 sex:Site + sex:Temp + sex:Light + Site:Temp + Site:Light + Temp:Light + 
                 Site:Light:Temp +
                 (1|Female2), 
               REML = FALSE, 
               na.action = 'na.omit', data = Instars) #boundary (singular) fit: see ?isSingular

LmerM2 <- lmer(as.numeric(Mass_Adult) ~ sex + Site + Temp + Light + 
                 sex:Site + sex:Temp + sex:Light + Site:Temp + Site:Light + Temp:Light + 
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars)

LmerM3 <- lmer(as.numeric(Mass_Adult) ~ sex + Site + Temp + Light + 
                 Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars) #boundary (singular) fit: see ?isSingular

LmerM4 <- lmer(as.numeric(Mass_Adult) ~ Site + Temp + Light + 
                 Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                 (1|Female2), 
               REML = FALSE, 
               na.action = 'na.omit', data = Instars) #boundary (singular) fit: see ?isSingular

LmerM5 <- lmer(as.numeric(Mass_Adult) ~ Site + Temp + Light + 
                 Site:Temp + Site:Light + Temp:Light +
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars) #boundary (singular) fit: see ?isSingular

aictab(list(LmerM0, LmerM1, LmerM2, LmerM3, LmerM4, LmerM5), modnames = c("LmerM0", "LmerM1", "LmerM2", "LmerM3", "LmerM4", "LmerM5"))

#M2 is preferred, followed closely by M3 and M1


```


Table 2
```{r}
a <- Anova(LmerM0, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("adultanova.png")
```

### Preferred body temperature

```{r, include=FALSE}
#rm(list=ls(all = TRUE))

library(stringr)
library(foreach)
library(ggplot2)
library(grid)
library(gridExtra)
library(plotrix)

source('Functions.R') #PC, can do via R studio as well

####### Input files ##########

setwd("./data/")

#upload PBT data
PBT <- read.csv(file = "PBTdata_06202016_ALL.csv", header = TRUE, stringsAsFactors = FALSE)

str(PBT)

###### Clean up the data ############

#collect treatment labels
Labels <- str_split_fixed(PBT[,1], "_", n = 4) #collect Temp and Light treatments
PBT$Temp <- Labels[,2]
PBT$Light <- Labels[,3]
PBT$Site <- Labels[,4]

HopRaw <- read.csv(file = "Pdodge_PerformanceData1_06202016_ALL.csv", header = TRUE, stringsAsFactors = FALSE)
SexData <- data.frame(HopRaw$Individual, HopRaw$sex, stringsAsFactors = FALSE)

PBT <- merge(PBT, SexData, by.x =  colnames(PBT)[1], by.y = colnames(SexData)[1])
colnames(PBT)[27] <- "Sex"
PBT$Sex <- ifelse(PBT$Sex == "", NA, PBT$Sex)


#trim out missing data (rows with no values)
PBT <- PBT[is.na(PBT$t_enter_grad) == FALSE, ]

######## calculate median and mean TB for each individual ###############

TB_df <- data.frame(PBT$Tb_1, PBT$Tb_2, PBT$Tb_3, PBT$Tb_4, PBT$Tb_5, PBT$Tb_6)

PBT$Tb_Mean <- apply(TB_df, 1, mean, na.rm = TRUE)
PBT$Tb_Median <- apply(TB_df, 1, median, na.rm = TRUE)
PBT$Tb_sd <- apply(TB_df, 1, sd, na.rm = TRUE)

######## Sample Size ##########

PBT$Treat <- paste(PBT$Temp, PBT$Light, sep = "_")
table(PBT[,c(26,27,31)]) #results collated in google drive file "Performance Sample Sizes"
```


[Some text here]

Figure 4
```{r}
#plot based on individual means
MinSE <- function(x) {mean(x, na.rm = TRUE) - std.error(x, na.rm = TRUE)}
MaxSE <- function(x) {mean(x, na.rm = TRUE) + std.error(x, na.rm = TRUE)}

Give.N <- function(x){
  return(c(y = MaxSE(x)*1.01, label = length(x))) 
}


ggplot(data = PBT %>% filter(!is.na(Sex)), aes(x = Site, y = Tb_Mean, color = Temp)) +
#  rory_theme +
  facet_grid(Sex~Light, labeller=labeller(sex = sex.labs, Light = Light.labs)) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun.y = mean, geom = "line", size = .5, position = position_dodge(width = .3)) +
  stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 4) +
  ylab("Mean PBT (C)") + xlab("Site")+scale_color_manual(name="Temp var", labels=c("High var", "Low var"), values = c("#D6604D", "#4393C3")) + scale_x_discrete(labels=c("2195m", "2591m", "3048m"))+ theme(axis.text.x = element_text(angle = 90, vjust = .2, hjust=1))

```

```{r, echo=FALSE}
##### Analyses #####
PBT_2 <- merge(PBT, Instars[,c(1,3,54)], by.x = "Individual", by.y = "Individual")
PBT_Long <- melt(PBT_2[,c(1,3,10,12,14,16,18,20,24:27,31,33)], id.var = c("Individual", "TprefBATCH", "Female2", "Temp", "Light", "Site", "Sex", "Treat"))
PBT_Long$Temp <- as.factor(PBT_Long$Temp)
PBT_Long$Light <- as.factor(PBT_Long$Light)
PBT_Long$Site <- as.factor(PBT_Long$Site)
PBT_Long$Sex <- as.factor(PBT_Long$Sex)
PBT_Long$Individual <- as.factor(PBT_Long$Individual)


hist(PBT_Long$value) #looks quite normal

LmerPBT.0 <- lmer(value ~ Sex * Site * Temp * Light + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long) #initially attempted to include batch and female, but so little variation that the scales were off and the model showed errors

LmerPBT.1 <- lmer(value ~ Sex + Site + Temp + Light + 
                    Sex:Site + Sex:Temp + Sex:Light + Site:Temp + Site:Light + Temp:Light + 
                    Site:Light:Temp +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.2 <- lmer(value ~ Sex + Site + Temp + Light + 
                    Sex:Site + Sex:Temp + Sex:Light + Site:Temp + Site:Light + Temp:Light + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.3 <- lmer(value ~ Sex + Site + Temp + Light + 
                    Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.4 <- lmer(value ~ Site + Temp + Light + 
                    Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.5 <- lmer(value ~ Site + Temp + Light + 
                    Site:Temp + Site:Light + Temp:Light +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.6 <- lmer(value ~ Sex + Site + Temp + Light + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, #this was initially commented out
                  data = PBT_Long)

LmerPBT.7 <- lmer(value ~ Site + Temp + Light + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

aictab(list(LmerPBT.0, LmerPBT.1, LmerPBT.2, LmerPBT.3, LmerPBT.4, LmerPBT.5, LmerPBT.6, LmerPBT.7), modnames = c("LmerPBT.0", "LmerPBT.1", "LmerPBT.2", "LmerPBT.3", "LmerPBT.4", "LmerPBT.5", "LmerPBT.6", "LmerPBT.7"))
#LmerPBT.6 is the preferred model, delta AIC = 7.14 (no interactions)

```

```{r}
a <- Anova(LmerPBT.6, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("adultanova.png")
```

```{r}
lsmeans(LmerPBT.6, pairwise ~ Site|Temp+Light) #Sites never significantly differ from one another
lsmeans(LmerPBT.6, pairwise ~ Light|Temp) #L and S differ in LV only
lsmeans(LmerPBT.6, pairwise ~ Temp|Light) #HV and LV differ, only in long days and primarilly for C1
```


### CTmin and CTmax

CTmin (will reformat)
```{r}
#CT
ggplot(data = CT, aes(x = Site, y = CT_min, color = Temp)) +
  #rory_theme +
  facet_wrap(Sex~Light, nrow = 1) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = 1.5, position = position_dodge(width = .6)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun.y = mean, geom = "line", size = 1.5, position = position_dodge(width = .6)) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("CTmin (C)") + xlab("Site")+scale_color_viridis_d()

```

CTmax (will reformat)
```{r}
ggplot(data = CT, aes(x = Site, y = CT_max, color = Temp)) +
  rory_theme +
  facet_wrap(Sex~Light, nrow = 1) +
  stat_summary(fun.y = mean, fun.ymin = MinSE, fun.ymax = MaxSE, na.rm = TRUE, size = 1.5, position = position_dodge(width = .6)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun.y = mean, geom = "line", size = 1.5, position = position_dodge(width = .6)) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("CTmax (C)") + xlab("Site")+scale_color_viridis_d()
```

```{r}
#singular fit for CTmin :(

CT <- CT %>% mutate(Female=sub("\\..*", "", Individual)) #Individuals only show up in one row. But I'm deducing that the start of the individual's name (before the period) is the mother

LmerCTmax.4 <- lmer(as.numeric(CT_max) ~ Site + Temp + Light + 
                   Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                   (1|Female), 
                 REML = FALSE, 
                 na.action = 'na.omit', data = CT) 

LmerCTmin.4 <- lmer(as.numeric(CT_min) ~ Site + Temp + Light + 
                      Site:Temp + Site:Light + Temp:Light + Site:Temp:Light +
                      (1|Female), 
                    REML = FALSE, 
                    na.action = 'na.omit', data = CT) 
#table for CTmin
a <- Anova(LmerCTmin.4, type=3) 
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("adultanova.png")

#table for CTmin
a <- Anova(LmerCTmax.4, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("adultanova.png")

```


Note: missing supplementary materials... will add them in!


