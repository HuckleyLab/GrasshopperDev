---
title: "analysis_concise_clean"
output: html_document
---

#Set up

Set working directory to source file location
```{r setup}
knitr::opts_knit$set(root.dir = './')
```

Load packages and functions
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Initial
rm(list=ls(all = TRUE))
library(stringr)
library(foreach)
library(ggplot2)
library(grid)
library(gridExtra)
library(plotrix)
library(nlme)
library(lme4)
library(car)
library(AICcmodavg)
library(lsmeans)
library(reshape2)
library(MASS)
library(nls2)
library(tidyverse)
library(kableExtra)
library(faraway)
library(sjPlot) #for plot_new
library(tidyverse)
library(knitr)
library(afex)
library(RColorBrewer)
library(ggeffects)
library(cowplot)
library(stringr)

#webshot::install_phantomjs()
library(kableExtra)

source('Functions.R')

```

Functions and labels
```{r}


# New facet label names for supp variable
Photoperiod.labs <- c("Long photoperiod", "Short photoperiod")
names(Photoperiod.labs) <- c("L", "S")
 
#Temperature.labs <- c("High var", "Low var")
#names(Temperature.labs) <- c("HV", "LV")
##decided to stick with HV and LB

#plot based on individual means
MinSE <- function(x) {mean(x, na.rm = TRUE) - std.error(x, na.rm = TRUE)}
MaxSE <- function(x) {mean(x, na.rm = TRUE) + std.error(x, na.rm = TRUE)}

Give.N <- function(x){
  return(c(y = MaxSE(x)*1.01, label = length(x))) 
}
```

Growth and development data
```{r}
# Instars from GrowthRate_Script_2016.R
Instars <- read.csv(file = "data/GrasshopperData_3rdToAdult_SPR16.csv", header = TRUE, stringsAsFactors = FALSE)
#str(Instars)
Instars$sex <- ifelse(Instars$sex == "", NA, Instars$sex)

#Format dates and calculate ages
Instars$Date1_Hatch <- as.Date(Instars$Date_Hatch, format = "%m/%d/%Y")
Instars$Date1_1st <- as.Date(Instars$Date_1st, format = "%m/%d/%Y")
Instars$Date1_2nd <- as.Date(Instars$Date_2nd, format = "%m/%d/%Y")
Instars$Date1_3rd <- as.Date(Instars$Date_3rd, format = "%m/%d/%Y")
Instars$Date1_4th <- as.Date(Instars$Date_4th, format = "%m/%d/%Y")
Instars$Date1_5th <- as.Date(Instars$Date_5th, format = "%m/%d/%Y")
Instars$Date1_5th. <- as.Date(Instars$Date_5th., format = "%m/%d/%Y")
Instars$Date1_Adult <- as.Date(Instars$Date_Adult, format = "%m/%d/%Y")
Instars$Date1_Death <- as.Date(Instars$Date_Death, format = "%m/%d/%Y")

Instars$Age_3rd <- Instars$Date1_3rd - Instars$Date1_Hatch
Instars$Age_4th <- Instars$Date1_4th - Instars$Date1_Hatch
Instars$Age_5th <- Instars$Date1_5th - Instars$Date1_Hatch
Instars$Age_Adult <- Instars$Date1_Adult - Instars$Date1_Hatch

#trim out pell data
Instars <- Instars[Instars$Species == "dodg",]

#set factors
Instars$Site <- as.factor(Instars$Site)
Instars$sex <- as.factor(Instars$sex)
Instars$Temp <- as.factor(Instars$Temp)
Instars$Light <- as.factor(Instars$Light)
Instars$Female <- as.factor(Instars$Female)
Instars$Female2 <- as.factor(paste(Instars$Female, Instars$Site, sep = "_")) 
  #Female2 gives each mother her own ID (differentiates between FY1's across sites)
Instars= Instars[which(Instars$sex %in% c("F","M")),] #ADDING THIS HERE -- I think we do this in effect anyway

Instars_names <- Instars %>% rename(Sex=sex, Temperature=Temp, Photoperiod=Light)
Instars_names$Site <- recode(Instars_names$Site, A1 = "2195m", B1="2591m", C1="3048m")
Instars_names$Sex <- recode(Instars_names$Sex, M = "Male", F="Female")

#For devinstelopment by instar
D_Instars_Adult <- Instars_names[is.na(Instars_names$Age_Adult) == FALSE,]
D_Instars_Adult_Long <- melt(D_Instars_Adult[,c(1:8,50:54)], id.vars = c("Individual", "CCode", "Female", "Female2", "Site", "Species", "Sex", "Temperature", "Photoperiod")) 
#Make instar numeric
D_Instars_Adult_Long$Instar=3
D_Instars_Adult_Long$Instar[D_Instars_Adult_Long$variable=="Age_4th"]=4
D_Instars_Adult_Long$Instar[D_Instars_Adult_Long$variable=="Age_5th"]=5
D_Instars_Adult_Long$Instar[D_Instars_Adult_Long$variable=="Age_Adult"]=6

#For mass by instar
M_Instars_Adult <- Instars_names[is.na(Instars_names$Mass_Adult) == FALSE,]
M_Instars_Adult_Long <-  melt(M_Instars_Adult[,c(1:8,18,21,24,30,54)], id.vars = c("Individual", "CCode", "Female", "Female2", "Site", "Species", "Sex", "Temperature", "Photoperiod")) #tracks the mass (value) when each individual reached each instar (variable)
#Make instar numeric
M_Instars_Adult_Long$Instar=3
M_Instars_Adult_Long$Instar[M_Instars_Adult_Long$variable=="Mass_4th"]=4
M_Instars_Adult_Long$Instar[M_Instars_Adult_Long$variable=="Mass_5th"]=5
M_Instars_Adult_Long$Instar[M_Instars_Adult_Long$variable=="Mass_Adult"]=6



```

PBT data
```{r}
PBT <- read.csv(file = "./data/PBTdata_06202016_ALL.csv", header = TRUE, stringsAsFactors = FALSE)

#str(PBT)

# Clean up the data 

#collect treatment labels
Labels <- str_split_fixed(PBT[,1], "_", n = 4) #collect Temp and Light treatments
PBT$Temp <- Labels[,2]
PBT$Light <- Labels[,3]
PBT$Site <- Labels[,4]

HopRaw <- read.csv(file = "./data/Pdodge_PerformanceData1_06202016_ALL.csv", header = TRUE, stringsAsFactors = FALSE)
SexData <- data.frame(HopRaw$Individual, HopRaw$sex, stringsAsFactors = FALSE)

PBT <- merge(PBT, SexData, by.x =  colnames(PBT)[1], by.y = colnames(SexData)[1])
colnames(PBT)[27] <- "Sex"
PBT$Sex <- ifelse(PBT$Sex == "", NA, PBT$Sex)


#trim out missing data (rows with no values)
PBT <- PBT[is.na(PBT$t_enter_grad) == FALSE, ]

# calculate median and mean TB for each individual

TB_df <- data.frame(PBT$Tb_1, PBT$Tb_2, PBT$Tb_3, PBT$Tb_4, PBT$Tb_5, PBT$Tb_6)

PBT$Tb_Mean <- apply(TB_df, 1, mean, na.rm = TRUE)
PBT$Tb_Median <- apply(TB_df, 1, median, na.rm = TRUE)
PBT$Tb_sd <- apply(TB_df, 1, sd, na.rm = TRUE)

# Sample Size

PBT$Treat <- paste(PBT$Temp, PBT$Light, sep = "_")
#table(PBT[,c(26,27,31)]) #results collated in google drive file "Performance Sample Sizes"

PBT_2 <- merge(PBT, Instars[,c(1,3,54)], by.x = "Individual", by.y = "Individual")
PBT_Long <- melt(PBT_2[,c(1,3,10,12,14,16,18,20,24:27,31,33)], id.var = c("Individual", "TprefBATCH", "Female2", "Temp", "Light", "Site", "Sex", "Treat"))
PBT_Long$Temp <- as.factor(PBT_Long$Temp)
PBT_Long$Light <- as.factor(PBT_Long$Light)
PBT_Long$Site <- as.factor(PBT_Long$Site)
PBT_Long$Sex <- as.factor(PBT_Long$Sex)
PBT_Long$Individual <- as.factor(PBT_Long$Individual)


PBT_Long <- PBT_Long %>% rename(Temperature=Temp, Photoperiod=Light)
PBT_Long$Site <- recode(PBT_Long$Site, A1 = "2195m", B1="2591m", C1="3048m")
PBT_Long$Sex <- recode(PBT_Long$Sex, M = "Male", F="Female")

PBT <- PBT %>% rename(Temperature=Temp, Photoperiod=Light)
PBT$Site <- recode(PBT$Site, A1 = "2195m", B1="2591m", C1="3048m")
PBT$Sex <- recode(PBT$Sex, M = "Male", F="Female")
```

CT data
```{r}
CT <- read.csv(file = "./data/CT_Data_2016.csv", header = TRUE)
HopRaw <- read.csv(file = "./data/Pdodge_PerformanceData1_06202016_ALL.csv", header = TRUE, stringsAsFactors = FALSE)
SexData <- data.frame(HopRaw$Individual, HopRaw$sex, stringsAsFactors = FALSE)

CT <- merge(CT, SexData, by.x =  colnames(CT)[1], by.y = colnames(SexData)[1])
colnames(CT)[ncol(CT)] <- "Sex"
CT$Sex <- ifelse(CT$Sex == "", NA, CT$Sex)

#Drop cases with no sex
CT= subset(CT, CT$Sex %in% c("M","F"))
CT <- CT %>% mutate(Female=sub("\\..*", "", Individual)) %>% rename(Temperature=Temp, Photoperiod=Light) #Individuals only show up in one row. But I'm deducing that the start of the individual's name (before the period) is the mother

CT$Site <- recode(CT$Site, A1 = "2195m", B1="2591m", C1="3048m")
CT$Sex <- recode(CT$Sex, M = "Male", F="Female")

```

Hopping data
```{r}
HopRaw <- read.csv(file = "./data/Pdodge_PerformanceData1_06202016_ALL.csv", header = TRUE, stringsAsFactors = FALSE)

#HopRaw <- HopRaw[is.na(HopRaw$TEST.TEMP1) == FALSE, ] #remove individuals that we couldn't measure

Labels <- str_split_fixed(HopRaw[,1], "_", n = 4) #collect Temp and Light treatments
HopRaw$Temp <- Labels[,2]
HopRaw$Light <- Labels[,3]

#stack TEST1, TEST2, and TEST3 in pseudo-longform (HopPL)
Hop1 <- HopRaw[, c(1:6, 60:61, 7:19)]
colnames(Hop1) <- c("ID", "Batch", "CC", "Site", "Species", "Sex", "Temp", "Light", "TestTemp", "Y0", "X0", "Y1", "X1", "Y2", "X2", "Y3", "X3", "Y4", "X4", "Y5", "X5")
Hop2 <- HopRaw[, c(1:6, 60:61, 20:32)]
colnames(Hop2) <- c("ID", "Batch", "CC", "Site", "Species", "Sex", "Temp", "Light", "TestTemp", "Y0", "X0", "Y1", "X1", "Y2", "X2", "Y3", "X3", "Y4", "X4", "Y5", "X5")
Hop3 <- HopRaw[, c(1:6, 60:61, 33:45)]
colnames(Hop3) <- c("ID", "Batch", "CC", "Site", "Species", "Sex", "Temp", "Light", "TestTemp", "Y0", "X0", "Y1", "X1", "Y2", "X2", "Y3", "X3", "Y4", "X4", "Y5", "X5")
Hop4 <- HopRaw[, c(1:6, 60:61, 46:58)]
colnames(Hop4) <- c("ID", "Batch", "CC", "Site", "Species", "Sex", "Temp", "Light", "TestTemp", "Y0", "X0", "Y1", "X1", "Y2", "X2", "Y3", "X3", "Y4", "X4", "Y5", "X5")

HopPL <- rbind(Hop1, Hop2, Hop3, Hop4)

#remove rows with no values
HopPL <- HopPL[is.na(HopPL$TestTemp) == FALSE, ] #remove individuals that we couldn't measure

# Convert measures from Feet_Inches to cm

#Function to convert a single vector (input is a Feet_Inches vector and output is a CM vector)
HopsToCM <- function(Vec) {
  Div <- data.frame(str_split_fixed(Vec, "_", n = 2), stringsAsFactors = FALSE) #divide components
  DivI <- 12 * as.numeric(Div[,1]) #convert feet to inches
  Inches <- DivI + as.numeric(Div[,2]) #total inches
  CM <- Inches * 2.5 #convert inches to cm
  return(CM)
}

#Function to convert an entire dataframe (uses above function) (input is a DF of Feet_Inches vectors and output is a DF of CM vectors)
HopsToCM_ALL <- function(DF) {
  NewPoints <- foreach(i = 1:ncol(DF), .combine = cbind) %do%
    HopsToCM(DF[,i])
  NewPoints <- data.frame(NewPoints)
  colnames(NewPoints) <- colnames(DF)
  return(NewPoints)
}

#convert all measures to CM using above functions
CM <- HopsToCM_ALL(HopPL[,10:21])

#reattach metadata
HopCM <- cbind(HopPL[,1:9], CM)


# Calculate Euclidian Distances

EucDist <- function (X1, Y1, X2, Y2) {sqrt((X2-X1)^2 + (Y2-Y1)^2)} #Input coordinates and output Euclidean Distance

HopDist <- function(DF) {
  Hop1 <- EucDist(DF$X0, DF$Y0, DF$X1, DF$Y1)
  Hop2 <- EucDist(DF$X1, DF$Y1, DF$X2, DF$Y2)
  Hop3 <- EucDist(DF$X2, DF$Y2, DF$X3, DF$Y3)
  Hop4 <- EucDist(DF$X3, DF$Y3, DF$X4, DF$Y4)
  Hop5 <- EucDist(DF$X4, DF$Y4, DF$X5, DF$Y5)
  Hops <- data.frame(cbind(Hop1, Hop2, Hop3, Hop4, Hop5))
  return(Hops)
} #Input DF with numeric columns labeled "X0" "Y0" ... "X5" "Y5" and get dataframe of hop distances as output.  Uses EucDist above

HopLengths <- HopDist(HopCM)

#Add distances to full dataframe
Hop <- cbind(HopCM, HopLengths)


# Calculate summary statistics for hops (use "apply" to use function across rows rather than columns)
Hop$Mean <- apply(HopLengths, 1, mean, na.rm = TRUE)
Hop$SD <- apply(HopLengths, 1, sd, na.rm = TRUE)
Hop$Min <- apply(HopLengths, 1, min, na.rm = TRUE)
Hop$Max <- apply(HopLengths, 1, max, na.rm = TRUE)
Hop$Median <- apply(HopLengths, 1, median, na.rm = TRUE)


# Assign Factors
Hop$Batch <- as.factor(Hop$Batch)
Hop$Site <- as.factor(Hop$Site)
Hop$Species <- as.factor(Hop$Species)
Hop$Sex <- as.factor(Hop$Sex)
Hop$Temp <- as.factor(Hop$Temp)
Hop$Light <- as.factor(Hop$Light)
Hop$TestTempF <- as.factor(Hop$TestTemp)
Hop$Treat <- paste(Hop$Temp, Hop$Light, sep = "_")

#Drop cases with no sex
Hop <- Hop %>% rename(Temperature=Temp, Photoperiod=Light)
Hop$Site <- recode(Hop$Site, A1 = "2195m", B1="2591m", C1="3048m")
Hop$Sex <- recode(Hop$Sex, M = "Male", F="Female")

Hop_2 <- merge(Hop, Instars[,c(1,3,54)], by.x = "ID", by.y = "Individual") #Instars from the "GrowthRate_Script_2016"

#make data long form
Hop_Long <- melt(Hop_2[, c(1:9, 22:26, 33:35)], id.vars = c("ID", "Batch", "CC", "Site", "Species", "Sex", "Temperature", "Photoperiod", "Treat", "Female", "Female2", "TestTemp"))

```

Feeding data (requires growth and development data)
```{r}
FeedRaw <- read.csv(file = "./data/FeedingRate_Data_All_03152017.csv", header = TRUE, stringsAsFactors = FALSE)


#bring in hopping data which have sex
HopRaw <- read.csv(file = "./data/Pdodge_PerformanceData1_06202016_ALL.csv", header = TRUE, stringsAsFactors = FALSE) #remove individuals that we couldn't measure
#add sex with merge
FeedRaw <- merge(FeedRaw, HopRaw[,c(1,6)], by.x = "Individual.ID..EGGPOD..HATCHING._TEMP_LIGHT_SPECIES_SITE.", by.y = "Individual", all.x = TRUE)
#divide super label into informative treatments
Labels <- str_split_fixed(FeedRaw[,1], "_", n = 4) #collect Temp and Light treatments
FeedRaw$Temp <- Labels[,2]
FeedRaw$Light <- Labels[,3]
FeedRaw$Population <- Labels[,4]
FeedRaw$ID <- Labels[,1]
ID_Labels <- str_split_fixed(FeedRaw$ID, "[.]", n = 2)
FeedRaw$Mom <- ID_Labels[,1]
FeedRaw$Species <- "dodg"

#stack Feed1, Feed2, and Feed3 in pseudo-longform (FeedPL)
Feed1 <- FeedRaw[, c(31:33, 27:30, 1:2, 3:10)]
colnames(Feed1) <- c("ID", "Mom", "Species", "Sex", "Temp", "Light", "Site", "FULL_ID", "Batch", "Date", "TestTemp", "SubBatch", "Position", "Area1", "Area2", "Area3", "Area4")
Feed2 <- FeedRaw[, c(31:33, 27:30, 1:2, 11:18)]
colnames(Feed2) <- c("ID", "Mom", "Species", "Sex", "Temp", "Light", "Site", "FULL_ID", "Batch", "Date", "TestTemp", "SubBatch", "Position", "Area1", "Area2", "Area3", "Area4")
Feed3 <- FeedRaw[, c(31:33, 27:30, 1:2, 19:26)]
colnames(Feed3) <- c("ID", "Mom", "Species", "Sex", "Temp", "Light", "Site", "FULL_ID", "Batch", "Date", "TestTemp", "SubBatch", "Position", "Area1", "Area2", "Area3", "Area4")

FeedPL <- rbind(Feed1, Feed2, Feed3)

#remove rows with no values or missing sex
FeedPL <- FeedPL[is.na(FeedPL$TestTemp) == FALSE, ] #remove individuals that we couldn't measure
FeedPL <- FeedPL[is.na(FeedPL$Sex) == FALSE & FeedPL$Sex!= "", ]

#####Convert Measured Areas to Amounts Eaten#######
FeedPL$P1_Consumed <- FeedPL$Area1-FeedPL$Area2
FeedPL$P2_Consumed <- FeedPL$Area3-FeedPL$Area4
FeedPL$Tot_Consumed <- FeedPL$P1_Consumed + FeedPL$P2_Consumed

####### Assign Factors ######

FeedPL$Batch <- as.factor(FeedPL$Batch)
FeedPL$Site <- as.factor(FeedPL$Site)
FeedPL$Species <- as.factor(FeedPL$Species)
FeedPL$Sex <- as.factor(FeedPL$Sex)
FeedPL$Temp <- as.factor(FeedPL$Temp)
FeedPL$Light <- as.factor(FeedPL$Light)
FeedPL$TestTempF <- as.factor(FeedPL$TestTemp)
FeedPL$Treat <- paste(FeedPL$Temp, FeedPL$Light, sep = "_")

FeedPL <- FeedPL %>% rename(Temperature=Temp, Photoperiod=Light)
FeedPL$Site <- recode(FeedPL$Site, A1 = "2195m", B1="2591m", C1="3048m")
FeedPL$Sex <- recode(FeedPL$Sex, M = "Male", F="Female")

#AdultsOnly <- Instars_names[is.na(Instars_names$Femur_Adult) == FALSE, ]
#AdultsOnly <- AdultsOnly[is.na(AdultsOnly$Sex) == FALSE, ]
Adultmass <- Instars_names %>% rename(FULL_ID = Individual) %>% select(FULL_ID, Mass_Adult)
FeedPLmass <- merge(FeedPL, Adultmass, by="FULL_ID") 
FeedPLmass <- FeedPLmass %>% mutate(Tot_Consumed_scaled=Tot_Consumed/Mass_Adult, 
                                    P1_Consumed_scaled = P1_Consumed/Mass_Adult,
                                    P2_Consumed_scaled = P2_Consumed/Mass_Adult)

```


#Growth and Development
##Figure 1: Adult age and mass
```{r}
Instars_names_devinstmass <- Instars_names %>% 
  rename(`Time to adult (d)` = Age_Adult, `Mass as adult (g)` = Mass_Adult) %>%
  gather(key="meas", value="y", `Time to adult (d)`, `Mass as adult (g)`) %>%
  transform(meas=factor(meas,levels=c("Time to adult (d)", "Mass as adult (g)")))
#^I think the warning is ok. We want mass to be numeric / age can be also



p.devmass <- ggplot(data = Instars_names_devinstmass, aes(x = Site, y = y, color = Temperature, linetype=Sex, shape=Sex)) +
  facet_grid(meas~Photoperiod, scales="free_y", labeller=labeller(Photoperiod = Photoperiod.labs), switch="y") +
  stat_summary(fun = mean, fun.min = MinSE, fun.max = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun = mean, geom = "line", size = .5, position = position_dodge(width = .3)) +
  xlab("Site")+scale_color_manual(values = c("#D6604D", "#4393C3")) + scale_shape_manual(values=c(16,1)) + 
  theme_bw() + theme(strip.background = element_blank(), axis.text.x = element_text(angle = 90, vjust = .2, hjust=1), axis.title.y = element_blank(), strip.placement = "outside")

p.devmass
#ggsave(p.devmass, file="Figures/Fig1_devmass.png")



```


## Dependent variable: Development time (to adulthood)
How do temperature variance (Temperature), photoperiod (Photoperiod), 
elevation of site of origin (Site), and sex (Sex) affect the age of maturation?

Look at the distribution -- it looks fairly normal
```{r}
hist(as.numeric(na.omit(Instars$Age_Adult)), breaks=10)
```

Compare different models, selecting the most complex (delta AICc>10)
```{r}
nLmer0 <- lmer(as.numeric(Age_Adult) ~ Sex * Site * Temperature * Photoperiod + 
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars_names)

nLmer1 <- lmer(as.numeric(Age_Adult) ~ Sex + Site + Temperature + Photoperiod + 
                 Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
                 Site:Photoperiod:Temperature +
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars_names)

nLmer2 <- lmer(as.numeric(Age_Adult) ~ Sex + Site + Temperature + Photoperiod + 
                 Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars_names)

nLmer3 <- lmer(as.numeric(Age_Adult) ~ Sex + Site + Temperature + Photoperiod + 
                 Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars_names)

nLmer4 <- lmer(as.numeric(Age_Adult) ~ Site + Temperature + Photoperiod + 
                 Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars_names)

nLmer5 <- lmer(as.numeric(Age_Adult) ~ Site + Temperature + Photoperiod + 
                 Site:Temperature + Site:Photoperiod + Temperature:Photoperiod +
                 (1|Female2), na.action = 'na.omit', REML=FALSE, data = Instars_names)

aictab(list(nLmer0, nLmer1, nLmer2, nLmer3, nLmer4, nLmer5), modnames = c("nLmer0", "nLmer1", "nLmer2", "nLmer3", "nLmer4", "nLmer5"))

#best is nLmer0
devmod <- nLmer0
```

## Development by instar
```{r}
#Lmer0.1 <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod * Instar + 
#                   (1|Female2/Individual), na.action = 'na.omit', REML=FALSE, data = Instars_Adult_Long)

devinstmod <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod * Instar + 
                   (1|Female2/Individual), na.action = 'na.omit', REML=FALSE, data = D_Instars_Adult_Long)
#what's warning?
```


## Dependent variable: Mass (at adulthood)
How do temperature variance (Temperature), photoperiod (Photoperiod), 
elevation of site of origin (Site), and sex (Sex) affect adult mass?

Check normal... well so it's not the most normal but at the moment I treat it like it is
```{r}
hist(as.numeric(Instars$Mass_Adult), breaks = 15)  

#a log would help a bit
#could also consider gamma
#in either of these cases glmer says model failed to converge for most complex
```

Model selection / AIC comparison 
```{r}

LmerM0 <- lmer(as.numeric(Mass_Adult) ~ Sex * Site * Temperature * Photoperiod + 
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars_names)

LmerM1 <- lmer(as.numeric(Mass_Adult) ~ Sex + Site + Temperature + Photoperiod + 
                 Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
                 Site:Photoperiod:Temperature +
                 (1|Female2), 
               REML = FALSE, 
               na.action = 'na.omit', data = Instars_names) #singular

LmerM2 <- lmer(as.numeric(Mass_Adult) ~ Sex + Site + Temperature + Photoperiod + 
                 Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars_names)

LmerM3 <- lmer(as.numeric(Mass_Adult) ~ Sex + Site + Temperature + Photoperiod + 
                 Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars_names) #singular

LmerM4 <- lmer(as.numeric(Mass_Adult) ~ Site + Temperature + Photoperiod + 
                 Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
                 (1|Female2), 
               REML = FALSE, 
               na.action = 'na.omit', data = Instars_names) #singular

LmerM5 <- lmer(as.numeric(Mass_Adult) ~ Site + Temperature + Photoperiod + 
                 Site:Temperature + Site:Photoperiod + Temperature:Photoperiod +
                 (1|Female2), 
               REML = FALSE,
               na.action = 'na.omit', data = Instars_names) #singular

aictab(list(LmerM0, LmerM1, LmerM2, LmerM3, LmerM4, LmerM5), modnames = c("LmerM0", "LmerM1", "LmerM2", "LmerM3", "LmerM4", "LmerM5"))

#M2 is preferred, followed closely by M3 and M1 (all within 2 of each other) we decided to go with M0 (delta AIC = 6.86)
#(see singularity issues for many other models... all but M2 and M0)
massmod <- LmerM0

```
##TESTING OTHERS
log
```{r}

# LmerM0 <- glmer(as.numeric(Mass_Adult) ~ Sex * Site * Temperature * Photoperiod + 
#                  (1|Female2), 
#                family = gaussian(link="log"),
#                na.action = 'na.omit', data = Instars_names)
# 
# LmerM1 <- glmer(as.numeric(Mass_Adult) ~ Sex + Site + Temperature + Photoperiod + 
#                  Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
#                  Site:Photoperiod:Temperature +
#                  (1|Female2), 
#                family = gaussian(link="log"), 
#                na.action = 'na.omit', data = Instars_names) #singular
# 
# LmerM2 <- glmer(as.numeric(Mass_Adult) ~ Sex + Site + Temperature + Photoperiod + 
#                  Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
#                  (1|Female2), 
#                family = gaussian(link="log"),
#                na.action = 'na.omit', data = Instars_names)
# 
# LmerM3 <- glmer(as.numeric(Mass_Adult) ~ Sex + Site + Temperature + Photoperiod + 
#                  Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
#                  (1|Female2), 
#                family = gaussian(link="log"),
#                na.action = 'na.omit', data = Instars_names) #singular
# 
# LmerM4 <- glmer(as.numeric(Mass_Adult) ~ Site + Temperature + Photoperiod + 
#                  Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
#                  (1|Female2), 
#                family = gaussian(link="log"), 
#                na.action = 'na.omit', data = Instars_names) #singular
# 
# LmerM5 <- glmer(as.numeric(Mass_Adult) ~ Site + Temperature + Photoperiod + 
#                  Site:Temperature + Site:Photoperiod + Temperature:Photoperiod +
#                  (1|Female2), 
#                family = gaussian(link="log"),
#                na.action = 'na.omit', data = Instars_names) #singular
# 
# aictab(list(LmerM0, LmerM1, LmerM2, LmerM3, LmerM4, LmerM5), modnames = c( "LmerM0", "LmerM1", "LmerM2", "LmerM3", "LmerM4", "LmerM5"))
# 
# #lower AIC, but "Model failed to converge" each time, less clear which model to choose
```
gamma
```{r}

# LmerM0 <- glmer(as.numeric(Mass_Adult) ~ Sex * Site * Temperature * Photoperiod + 
#                  (1|Female2), 
#                family = Gamma,
#                na.action = 'na.omit', data = Instars_names)
# 
# LmerM1 <- glmer(as.numeric(Mass_Adult) ~ Sex + Site + Temperature + Photoperiod + 
#                  Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
#                  Site:Photoperiod:Temperature +
#                  (1|Female2), 
#                family = Gamma, 
#                na.action = 'na.omit', data = Instars_names) #singular
# 
# LmerM2 <- glmer(as.numeric(Mass_Adult) ~ Sex + Site + Temperature + Photoperiod + 
#                  Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
#                  (1|Female2), 
#                family = Gamma,
#                na.action = 'na.omit', data = Instars_names)
# 
# LmerM3 <- glmer(as.numeric(Mass_Adult) ~ Sex + Site + Temperature + Photoperiod + 
#                  Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
#                  (1|Female2), 
#                family = Gamma,
#                na.action = 'na.omit', data = Instars_names) #singular
# 
# LmerM4 <- glmer(as.numeric(Mass_Adult) ~ Site + Temperature + Photoperiod + 
#                  Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
#                  (1|Female2), 
#                family = Gamma, 
#                na.action = 'na.omit', data = Instars_names) #singular
# 
# LmerM5 <- glmer(as.numeric(Mass_Adult) ~ Site + Temperature + Photoperiod + 
#                  Site:Temperature + Site:Photoperiod + Temperature:Photoperiod +
#                  (1|Female2), 
#                family = Gamma,
#                na.action = 'na.omit', data = Instars_names) #singular
# 
# aictab(list(LmerM0, LmerM1, LmerM2, LmerM3, LmerM4, LmerM5), modnames = c( "LmerM0", "LmerM1", "LmerM2", "LmerM3", "LmerM4", "LmerM5"))
# 
# #even lower AIC, but fails to converge each time
```

## Mass by instar
```{r}
massinstmod <- lmer(as.numeric(value) ~ Sex * Site * Temperature * Photoperiod * Instar + 
                   (1|Female2/Individual), na.action = 'na.omit', REML=FALSE, data = M_Instars_Adult_Long)
```


##Table 1: Adult age and mass anova
```{r}
devanova <- Anova(devmod, type=3)
devanova$Significance <- "   "
devanova$Significance[devanova$`Pr(>Chisq)`<.05] <- "*  "
devanova$Significance[devanova$`Pr(>Chisq)`<.001] <- "***"
devanova$`Pr(>Chisq)` <- format(devanova$`Pr(>Chisq)`, scientific=TRUE, digits=3)
devanova$`Pr(>Chisq)` <- as.character(devanova$`Pr(>Chisq)`)
devanova <- devanova %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")

massanova <- Anova(massmod, type=3)
massanova$Significance <- "   "
massanova$Significance[massanova$`Pr(>Chisq)`<.05] <- "*  "
massanova$Significance[massanova$`Pr(>Chisq)`<.001] <- "***"
massanova$`Pr(>Chisq)` <- format(massanova$`Pr(>Chisq)`, scientific=TRUE, digits=3)
massanova$`Pr(>Chisq)` <- as.character(massanova$`Pr(>Chisq)`)
massanova <- massanova %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
rownames(massanova) <- c()

devmassanova <- cbind(devanova, massanova)
options(knitr.kable.NA = '')
kable(devmassanova, digits=1, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p","<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() %>% add_header_above(c(" " = 1, "Time to adult" = 3, "Mass at adult" = 3)) #%>% save_kable("Tables/Tab1_devmassanova.png")
```

##Table S1: Age and mass coefficients
```{r}
devcoeff <- summary(devmod)
devcoeff <- data.frame(devcoeff[["coefficients"]])
devcoeff$Significance <- "   "
devcoeff$Significance[devcoeff$`Pr...t..`<.05] <- "*  "
devcoeff$Significance[devcoeff$`Pr...t..`<.001] <- "***"
devcoeff$`Pr...t..` <- format(devcoeff$`Pr...t..`, scientific=TRUE, digits=3)
devcoeff$`Pr...t..` <- as.character(devcoeff$`Pr...t..`)
devcoeff <- devcoeff %>% unite(p, c(`Pr...t..`, Significance), sep="")
rownames(devcoeff) <- rownames(devcoeff) %>% str_remove_all(paste(c("Sex", "Temperature", "Photoperiod", "Site"), collapse = "|")) %>% str_replace("S", "Short")
#shorter alternative is get rid of current str_replaces and add str_replace("Male", "M")

masscoeff <- summary(massmod)
masscoeff <- data.frame(masscoeff[["coefficients"]])
masscoeff$Significance <- "   "
masscoeff$Significance[masscoeff$`Pr...t..`<.05] <- "*  "
masscoeff$Significance[masscoeff$`Pr...t..`<.001] <- "***"
masscoeff$`Pr...t..` <- format(masscoeff$`Pr...t..`, scientific=TRUE, digits=3)
masscoeff$`Pr...t..` <- as.character(masscoeff$`Pr...t..`)
masscoeff <- masscoeff %>% unite(p, c(`Pr...t..`, Significance), sep="")
rownames(masscoeff) <- c()

devmasscoeff <- cbind(devcoeff, masscoeff)
options(knitr.kable.NA = '')
kable(devmasscoeff, digits=3, col.names=c("Coefficient", "Std. Error", "df", "t", "p", "Coefficient", "Std. Error", "df", "t", "p"), escape=FALSE, format="html") %>% kable_styling() %>% add_header_above(c(" " = 1, "Time to adult (d)" = 5, "Mass at adult (g)" = 5)) %>% save_kable("Tables/TabS1_devmasscoeff.png")

#change to digits=1? Or keep as is bc it's supplemental and might as well be precise... seems the latter is fine

```


## IMPORTANT NOTE: S2 and S3 mass values are new!
##Table S2: Development and mass by instar anova
```{r}
devinstanova <- Anova(devinstmod, type=3)
devinstanova$Significance <- "   "
devinstanova$Significance[devinstanova$`Pr(>Chisq)`<.05] <- "*  "
devinstanova$Significance[devinstanova$`Pr(>Chisq)`<.001] <- "***"
devinstanova$`Pr(>Chisq)` <- format(devinstanova$`Pr(>Chisq)`, scientific=TRUE, digits=3)
devinstanova$`Pr(>Chisq)` <- as.character(devinstanova$`Pr(>Chisq)`)
devinstanova <- devinstanova %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")

massinstanova <- Anova(massinstmod, type=3)
massinstanova$Significance <- "   "
massinstanova$Significance[massinstanova$`Pr(>Chisq)`<.05] <- "*  "
massinstanova$Significance[massinstanova$`Pr(>Chisq)`<.001] <- "***"
massinstanova$`Pr(>Chisq)` <- format(massinstanova$`Pr(>Chisq)`, scientific=TRUE, digits=3)
massinstanova$`Pr(>Chisq)` <- as.character(massinstanova$`Pr(>Chisq)`)
massinstanova <- massinstanova %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
rownames(massinstanova) <- c()

devmassinstanova <- cbind(devinstanova, massinstanova)
options(knitr.kable.NA = '')
kable(devmassinstanova, digits=1, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p","<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() %>% add_header_above(c(" " = 1, "Age" = 3, "Mass" = 3)) #%>% save_kable("Tables/TabS2_devmassinstanova.png")
```


##Table S3: Development and mass by instar coefficients
```{r}
devinstcoeff <- summary(devinstmod)
devinstcoeff <- data.frame(devinstcoeff[["coefficients"]])
devinstcoeff$Significance <- "   "
devinstcoeff$Significance[devinstcoeff$`Pr...t..`<.05] <- "*  "
devinstcoeff$Significance[devinstcoeff$`Pr...t..`<.001] <- "***"
devinstcoeff$`Pr...t..` <- format(devinstcoeff$`Pr...t..`, scientific=TRUE, digits=3)
devinstcoeff$`Pr...t..` <- as.character(devinstcoeff$`Pr...t..`)
devinstcoeff <- devinstcoeff %>% unite(p, c(`Pr...t..`, Significance), sep="")
rownames(devinstcoeff) <- rownames(devinstcoeff) %>% str_remove_all(paste(c("Sex", "Temperature", "Photoperiod", "Site"), collapse = "|")) %>% str_replace("S", "Short")
#shorter alternative is get rid of current str_replaces and add str_replace("Male", "M")

massinstcoeff <- summary(massinstmod)
massinstcoeff <- data.frame(massinstcoeff[["coefficients"]])
massinstcoeff$Significance <- "   "
massinstcoeff$Significance[massinstcoeff$`Pr...t..`<.05] <- "*  "
massinstcoeff$Significance[massinstcoeff$`Pr...t..`<.001] <- "***"
massinstcoeff$`Pr...t..` <- format(massinstcoeff$`Pr...t..`, scientific=TRUE, digits=3)
massinstcoeff$`Pr...t..` <- as.character(massinstcoeff$`Pr...t..`)
massinstcoeff <- massinstcoeff %>% unite(p, c(`Pr...t..`, Significance), sep="")
rownames(massinstcoeff) <- c()

devmassinstcoeff <- cbind(devinstcoeff, massinstcoeff)
options(knitr.kable.NA = '')
kable(devmassinstcoeff, digits=3, col.names=c("Coefficient", "Std. Error", "df", "t", "p", "Coefficient", "Std. Error", "df", "t", "p"), escape=FALSE, format="html") %>% kable_styling() %>% add_header_above(c(" " = 1, "Age (d)" = 5, "Mass (g)" = 5)) #%>% save_kable("Tables/TabS3_devmassinstcoeff.png")
```


#PBT, CTmin, CTmax
##Figure 2: PBT, CTmin, CTmax
```{r}
CTminmax <- CT %>% 
  rename(`CTmin (°C)`= CT_min, `CTmax (°C)`= CT_max) %>%
  gather(key="meas", value="y", `CTmin (°C)`, `CTmax (°C)`)

PBTnew <- PBT %>% filter(!is.na(Sex)) %>% #WONDERING if I should exclude Sex=NA when PBT is loaded
  rename(`PBT (°C)`= Tb_Mean) %>% gather(key="meas", value="y", `PBT (°C)`)

CTPBT <- merge(CTminmax, PBTnew, all = TRUE)


neworder <- c("CTmax (°C)", "PBT (°C)", "CTmin (°C)")
CTPBT2 <- arrange(transform(CTPBT,
             meas=factor(meas,levels=neworder)),meas)

p.CTPBT <- ggplot(data = CTPBT2, aes(x = Site, y = y, color = Temperature, linetype=Sex, shape=Sex)) +
  facet_grid(meas~Photoperiod, scales="free_y", labeller=labeller(Photoperiod = Photoperiod.labs), switch="y") +
  stat_summary(fun = mean, fun.min = MinSE, fun.max = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(as.factor(Site))), fun = mean, geom = "line", size = .5, position = position_dodge(width = .3)) +
  xlab("Site")+scale_color_manual(values = c("#D6604D", "#4393C3")) + scale_shape_manual(values=c(16,1)) + theme_bw() + theme(strip.background = element_blank(), strip.placement = "outside", axis.text.x = element_text(angle = 90, vjust = .2, hjust=1), axis.title.y = element_blank()) 

p.CTPBT
#ggsave(p.CTPBT, file="Figures/Fig2_CTPBT.png")

```

##PBT

```{r}
hist(PBT_Long$value) #looks fairly normal
```

```{r}
LmerPBT.0 <- lmer(value ~ Sex * Site * Temperature * Photoperiod + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long) #initially attempted to include batch and female, but so little variation that the scales were off and the model showed errors

LmerPBT.1 <- lmer(value ~ Sex + Site + Temperature + Photoperiod + 
                    Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
                    Site:Photoperiod:Temperature +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.2 <- lmer(value ~ Sex + Site + Temperature + Photoperiod + 
                    Sex:Site + Sex:Temperature + Sex:Photoperiod + Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.3 <- lmer(value ~ Sex + Site + Temperature + Photoperiod + 
                    Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.4 <- lmer(value ~ Site + Temperature + Photoperiod + 
                    Site:Temperature + Site:Photoperiod + Temperature:Photoperiod + Site:Temperature:Photoperiod +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.5 <- lmer(value ~ Site + Temperature + Photoperiod + 
                    Site:Temperature + Site:Photoperiod + Temperature:Photoperiod +
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

LmerPBT.6 <- lmer(value ~ Sex + Site + Temperature + Photoperiod + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, #this was initially commented out
                  data = PBT_Long)

LmerPBT.7 <- lmer(value ~ Site + Temperature + Photoperiod + 
                    (1|Individual), na.action = 'na.omit', 
                  REML = FALSE, 
                  data = PBT_Long)

aictab(list(LmerPBT.0, LmerPBT.1, LmerPBT.2, LmerPBT.3, LmerPBT.4, LmerPBT.5, LmerPBT.6, LmerPBT.7), modnames = c("LmerPBT.0", "LmerPBT.1", "LmerPBT.2", "LmerPBT.3", "LmerPBT.4", "LmerPBT.5", "LmerPBT.6", "LmerPBT.7"))
#LmerPBT.6 is the preferred model, delta AIC = 7.14 (no interactions)

PBTmod <- LmerPBT.6
```

## Table 2 (probably won't merge with Table 3 because of different modeling methods)
```{r}
PBTanova <- Anova(PBTmod, type=3)
PBTanova$Significance <- "   "
PBTanova$Significance[PBTanova$`Pr(>Chisq)`<.05] <- "*  "
PBTanova$Significance[PBTanova$`Pr(>Chisq)`<.001] <- "***"
PBTanova$`Pr(>Chisq)` <- format(PBTanova$`Pr(>Chisq)`, scientific=TRUE, digits=3)
PBTanova$`Pr(>Chisq)` <- as.character(PBTanova$`Pr(>Chisq)`)
PBTanova <- PBTanova %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(PBTanova, digits=1, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() %>% save_kable("Tables/Tab2_PBTanova.png")
```
##Table S4: PBT coefficients
```{r}
PBTcoeff <- summary(PBTmod)
PBTcoeff <- data.frame(PBTcoeff[["coefficients"]])
PBTcoeff$Significance <- "   "
PBTcoeff$Significance[PBTcoeff$`Pr...t..`<.05] <- "*  "
PBTcoeff$Significance[PBTcoeff$`Pr...t..`<.001] <- "***"
PBTcoeff$`Pr...t..` <- format(PBTcoeff$`Pr...t..`, scientific=TRUE, digits=3)
PBTcoeff$`Pr...t..` <- as.character(PBTcoeff$`Pr...t..`)
PBTcoeff <- PBTcoeff %>% unite(p, c(`Pr...t..`, Significance), sep="")
rownames(PBTcoeff) <- rownames(PBTcoeff) %>% str_remove_all(paste(c("Sex", "Temperature", "Photoperiod", "Site"), collapse = "|")) %>% str_replace("S", "Short")
#shorter alternative is get rid of current str_replaces and add str_replace("Male", "M")
options(knitr.kable.NA = '')
kable(PBTcoeff, digits=3, col.names=c("Coefficient", "Std. Error", "df", "t", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("Tables/TabS4_PBTcoeff.png")
```
##CTmin

```{r}
#exploring CT_min without random effects 

lm_site_min <- lm(as.numeric(CT_min) ~ Site,
                 na.action = 'na.omit', data = CT)

lm_temp_min <- lm(as.numeric(CT_min) ~ Temperature,
                 na.action = 'na.omit', data = CT)

lm_light_min <- lm(as.numeric(CT_min) ~ Photoperiod,
                 na.action = 'na.omit', data = CT)

lm_sex_min <- lm(as.numeric(CT_min) ~ Sex,
                 na.action = 'na.omit', data = CT) #new

lm_st_min <- lm(as.numeric(CT_min) ~ Site + Temperature,
                 na.action = 'na.omit', data = CT)

lm_sl_min <- lm(as.numeric(CT_min) ~ Site + Photoperiod,
                 na.action = 'na.omit', data = CT)

lm_tl_min <- lm(as.numeric(CT_min) ~ Temperature + Photoperiod,
                 na.action = 'na.omit', data = CT)

lm_sS_min <- lm(as.numeric(CT_min) ~ Site + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_tS_min <- lm(as.numeric(CT_min) ~ Temperature + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_lS_min <- lm(as.numeric(CT_min) ~ Photoperiod + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_sxt_min <- lm(as.numeric(CT_min) ~ Site * Temperature,
                 na.action = 'na.omit', data = CT)

lm_sxl_min <- lm(as.numeric(CT_min) ~ Site * Photoperiod,
                 na.action = 'na.omit', data = CT)

lm_txl_min <- lm(as.numeric(CT_min) ~ Temperature * Photoperiod,
                 na.action = 'na.omit', data = CT)

lm_stl_min <- lm(as.numeric(CT_min) ~ Temperature + Photoperiod + Site,
                 na.action = 'na.omit', data = CT)

lm_stlS_min <- lm(as.numeric(CT_min) ~ Temperature + Photoperiod + Site + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_sxtxl_min <- lm(as.numeric(CT_min) ~ Temperature * Photoperiod * Site,
                 na.action = 'na.omit', data = CT)

lm_sxtxlxS_min <- lm(as.numeric(CT_min) ~ Temperature * Photoperiod * Site * Sex,
                 na.action = 'na.omit', data = CT) #new

aictab(list(lm_site_min, lm_temp_min, lm_light_min, lm_sex_min, lm_st_min, lm_sl_min, lm_tl_min, lm_sS_min, lm_tS_min, lm_lS_min, lm_sxt_min, lm_sxl_min, lm_txl_min, lm_stl_min, lm_stl_min, lm_sxtxl_min, lm_sxtxlxS_min), modnames = c("lm_site_min", "lm_temp_min", "lm_light_min", "lm_sex_min", "lm_st_min", "lm_sl_min", "lm_tl_min", "lm_sS_min", "lm_tS_min", "lm_lS_min", "lm_sxt_min", "lm_sxl_min", "lm_txl_min", "lm_stl_min","lm_stlS_min", "lm_sxtxl_min", "lm_sxtxlxS_min"))

#select Temperature * Photoperiod
CTminmod <- lm_txl_min
```

Random effect leads to singularity issues and slightly worse AIC (same is true for CTmax)
```{r}
Lmermin_txl <- lmer(as.numeric(CT_min) ~ Temperature * Photoperiod +
                   (1|Female),
                 REML = FALSE,
                 na.action = 'na.omit', data = CT)
#singular

AIC(lm_txl_min, Lmermin_txl)
```

## CTmax
```{r}
#exploring CT_max without random effects 

lm_site_max <- lm(as.numeric(CT_max) ~ Site,
                 na.action = 'na.omit', data = CT)

lm_temp_max <- lm(as.numeric(CT_max) ~ Temperature,
                 na.action = 'na.omit', data = CT)

lm_light_max <- lm(as.numeric(CT_max) ~ Photoperiod,
                 na.action = 'na.omit', data = CT)

lm_sex_max <- lm(as.numeric(CT_max) ~ Sex,
                 na.action = 'na.omit', data = CT) #new

lm_st_max <- lm(as.numeric(CT_max) ~ Site + Temperature,
                 na.action = 'na.omit', data = CT)

lm_sl_max <- lm(as.numeric(CT_max) ~ Site + Photoperiod,
                 na.action = 'na.omit', data = CT)

lm_tl_max <- lm(as.numeric(CT_max) ~ Temperature + Photoperiod,
                 na.action = 'na.omit', data = CT)

lm_sS_max <- lm(as.numeric(CT_max) ~ Site + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_tS_max <- lm(as.numeric(CT_max) ~ Temperature + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_lS_max <- lm(as.numeric(CT_max) ~ Photoperiod + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_sxt_max <- lm(as.numeric(CT_max) ~ Site * Temperature,
                 na.action = 'na.omit', data = CT)

lm_sxl_max <- lm(as.numeric(CT_max) ~ Site * Photoperiod,
                 na.action = 'na.omit', data = CT)

lm_txl_max <- lm(as.numeric(CT_max) ~ Temperature * Photoperiod,
                 na.action = 'na.omit', data = CT)

lm_stl_max <- lm(as.numeric(CT_max) ~ Temperature + Photoperiod + Site,
                 na.action = 'na.omit', data = CT)

lm_stlS_max <- lm(as.numeric(CT_max) ~ Temperature + Photoperiod + Site + Sex,
                 na.action = 'na.omit', data = CT) #new

lm_sxtxl_max <- lm(as.numeric(CT_max) ~ Temperature * Photoperiod * Site,
                 na.action = 'na.omit', data = CT)

lm_sxtxlxS_max <- lm(as.numeric(CT_max) ~ Temperature * Photoperiod * Site * Sex,
                 na.action = 'na.omit', data = CT) #new

aictab(list(lm_site_max, lm_temp_max, lm_light_max, lm_sex_max, lm_st_max, lm_sl_max, lm_tl_max, lm_sS_max, lm_tS_max, lm_lS_max, lm_sxt_max, lm_sxl_max, lm_txl_max, lm_stl_max, lm_stl_max, lm_sxtxl_max, lm_sxtxlxS_max), modnames = c("lm_site_max", "lm_temp_max", "lm_light_max", "lm_sex_max", "lm_st_max", "lm_sl_max", "lm_tl_max", "lm_sS_max", "lm_tS_max", "lm_lS_max", "lm_sxt_max", "lm_sxl_max", "lm_txl_max", "lm_stl_max","lm_stlS_max", "lm_sxtxl_max", "lm_sxtxlxS_max"))

#ultimately select Temperature * Photoperiod (delta AIC=1.06) to go with CTmin
CTmaxmod <- lm_txl_max

```


##Table 3: CTmin and CTmax ANOVA
```{r}
#table for CTmin
CTminanova <- Anova(CTminmod, type=3)
CTminanova$Significance <- "   "
CTminanova$Significance[CTminanova$`Pr(>F)`<.05] <- "*  "
CTminanova$Significance[CTminanova$`Pr(>F)`<.001] <- "***"
CTminanova$`Pr(>F)` <- format(CTminanova$`Pr(>F)`, scientific=TRUE, digits=3)
CTminanova$`Pr(>F)` <- as.character(CTminanova$`Pr(>F)`)
CTminanova <- CTminanova %>% unite(p, c(`Pr(>F)`, Significance), sep="")
CTminanova[5,4] <- NA

CTmaxanova <- Anova(CTmaxmod, type=3)
rownames(CTmaxanova) <- c()
CTmaxanova$Significance <- "   "
CTmaxanova$Significance[CTmaxanova$`Pr(>F)`<.05] <- "*  "
CTmaxanova$Significance[CTmaxanova$`Pr(>F)`<.001] <- "***"
CTmaxanova$`Pr(>F)` <- format(CTmaxanova$`Pr(>F)`, scientific=TRUE, digits=3)
CTmaxanova$`Pr(>F)` <- as.character(CTmaxanova$`Pr(>F)`)
CTmaxanova <- CTmaxanova %>% unite(p, c(`Pr(>F)`, Significance), sep="")
CTmaxanova[5,4] <- NA

CTminmaxanova <- cbind(CTminanova,CTmaxanova)
options(knitr.kable.NA = '')
kable(CTminmaxanova, digits=1, col.names=c("Sum Sq", "df", "F value", "p", "Sum Sq", "df", "F value", "p"), escape=FALSE, format="html") %>% kable_styling() %>% add_header_above(c(" " = 1, "CTmin" = 4, "CTmax" = 4)) %>% save_kable("Tables/Tab3_CTminmaxanova.png")

```
## Table S5: CTmin and CTmax coefficients
```{r}
CTmincoeff <- summary(CTminmod)
CTmincoeff <- data.frame(CTmincoeff[["coefficients"]])
CTmincoeff$Significance <- "   "
CTmincoeff$Significance[CTmincoeff$`Pr...t..`<.05] <- "*  "
CTmincoeff$Significance[CTmincoeff$`Pr...t..`<.001] <- "***"
CTmincoeff$`Pr...t..` <- format(CTmincoeff$`Pr...t..`, scientific=TRUE, digits=3)
CTmincoeff$`Pr...t..` <- as.character(CTmincoeff$`Pr...t..`)
CTmincoeff <- CTmincoeff %>% unite(p, c(`Pr...t..`, Significance), sep="")
rownames(CTmincoeff) <- rownames(CTmincoeff) %>% str_remove_all(paste(c("Sex", "Temperature", "Photoperiod", "Site"), collapse = "|")) %>% str_replace("S", "Short")
#shorter alternative is get rid of current str_replaces and add str_replace("Male", "M")

CTmaxcoeff <- summary(CTmaxmod)
CTmaxcoeff <- data.frame(CTmaxcoeff[["coefficients"]])
CTmaxcoeff$Significance <- "   "
CTmaxcoeff$Significance[CTmaxcoeff$`Pr...t..`<.05] <- "*  "
CTmaxcoeff$Significance[CTmaxcoeff$`Pr...t..`<.001] <- "***"
CTmaxcoeff$`Pr...t..` <- format(CTmaxcoeff$`Pr...t..`, scientific=TRUE, digits=3)
CTmaxcoeff$`Pr...t..` <- as.character(CTmaxcoeff$`Pr...t..`)
CTmaxcoeff <- CTmaxcoeff %>% unite(p, c(`Pr...t..`, Significance), sep="")
rownames(CTmaxcoeff) <- c()

CTminmaxcoeff <- cbind(CTmincoeff, CTmaxcoeff)
options(knitr.kable.NA = '')
kable(CTminmaxcoeff, digits=3, col.names=c("Coefficient", "Std. Error", "t", "p", "Coefficient", "Std. Error",  "t", "p"), escape=FALSE, format="html") %>% kable_styling() %>% add_header_above(c(" " = 1, "CTmin (°C)" = 4, "CTmax (°C)" = 4)) #%>% save_kable("Tables/TabS5_CTminmaxcoeff.png")
```

#Performance

Tables still incomplete

##Figure 3: Hopping and feeding performance
```{r}
p.hop <- ggplot(data = Hop_Long, aes(x = TestTemp, y = value, col = Site)) +
  facet_grid(Temperature~Sex+Photoperiod, labeller=labeller(Photoperiod = Photoperiod.labs)) +
  stat_summary(fun = mean, fun.min = MinSE, fun.max = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(TestTemp)), fun = mean, geom = "line", size = .5, position = position_dodge(width = .3)) + scale_color_manual(labels=c("2195m", "2591m", "3048m"), values = brewer.pal(n = 8, name = "Blues")[c(8,6,4)]) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("Hopping distance (cm)") + xlab("") + theme_bw() + theme(strip.background = element_blank(), legend.position="none") + coord_cartesian(xlim=c(10, 40))

p.feed <- ggplot(data = FeedPLmass, aes(x = TestTemp, y = Tot_Consumed_scaled, col = Site)) +
  facet_grid(Temperature~Sex+Photoperiod, labeller=labeller(Photoperiod = Photoperiod.labs)) +
  stat_summary(fun = mean, fun.min = MinSE, fun.max = MaxSE, na.rm = TRUE, size = .5, position = position_dodge(width = .3)) +
  stat_summary(aes(x = as.numeric(TestTemp)), fun = mean, geom = "line", size = .5, position = position_dodge(width = .3)) + scale_color_manual(labels=c("2195m", "2591m", "3048m"), values = brewer.pal(n = 8, name = "Blues")[c(8,6,4)]) +
  #stat_summary(fun.data = Give.N, geom = "text", fun.y = median, position = position_dodge(width = .6), size = 7) +
  ylab("Mass-scaled leaf area consumed (cm²/g, 8h)") + xlab("Test temperature (°C)") + theme_bw() + theme(strip.background = element_blank(), axis.title.y = element_text(size=9), legend.position="bottom") + coord_cartesian(xlim=c(10, 40))

legend <- get_legend(p.feed)
#plot_grid(p.hop, p.feed + theme(legend.position="none"), legend, labels = c('a', 'b'), nrow=2)

p.perf <- plot_grid(p.hop, p.feed + theme(legend.position="none"), labels = c('a', 'b'), nrow=2) 
p.perf <- plot_grid(p.perf, legend, nrow=2, rel_heights = c(2, .1))
ggsave(p.perf, file="Figures/Fig3_perf.png")
p.perf #it looks weird in Rstudio for me but it's fine in the saved image (7x7)
```


##Hopping performance

visualize
```{r}

```

```{r}
#fullmodel
hopmod1 <- lmer(value ~ poly(TestTemp, 2, raw = TRUE) * Sex * Site * Temperature * Photoperiod + 
                   #(1|variable/ID/Female2), #original
                   #(1|Female2/ID/variable), #this gave a singularity issue 
                   (1|Female2/ID), #+ (1|variable), #so this did work -- might wanna double check it!
                 REML = FALSE, #
                 na.action = 'na.omit', data = Hop_Long)
hopmod2 <- lmer(value ~ TestTemp * Sex * Site * Temperature * Photoperiod + 
                   #(1|variable/ID/Female2), #original
                   #(1|Female2/ID/variable), #this gave a singularity issue 
                   (1|Female2/ID), #+ (1|variable), #so this did work -- might wanna double check it!
                 REML = FALSE, #
                 na.action = 'na.omit', data = Hop_Long)

aictab(list(hopmod1, hopmod2))

```



```{r}
#fullmodel
hopmod <- lmer(value ~ poly(TestTemp, 2, raw = TRUE) * Sex * Site * Temperature * Photoperiod + 
                   #(1|variable/ID/Female2), #original
                   #(1|Female2/ID/variable), #this gave a singularity issue 
                   (1|Female2/ID), #+ (1|variable), #so this did work -- might wanna double check it!
                 REML = FALSE, #
                 na.action = 'na.omit', data = Hop_Long)
```


```{r}
hopanova <- Anova(hopmod, type=3)

hopanova$Significance <- "   "
hopanova$Significance[hopanova$`Pr(>Chisq)`<.05] <- "*  "
hopanova$Significance[hopanova$`Pr(>Chisq)`<.001] <- "***"
hopanova$`Pr(>Chisq)` <- format(hopanova$`Pr(>Chisq)`, scientific=TRUE, digits=3)
hopanova$`Pr(>Chisq)` <- as.character(hopanova$`Pr(>Chisq)`)
hopanova <- hopanova %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(hopanova, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("hopanova.png")
```



For later (coefficient code)
```{r}
s <- summary(hopmod)
s <- data.frame(s[["coefficients"]])


s$Significance <- "   "
s$Significance[s$`Pr...t..`<.05] <- "*  "
s$Significance[s$`Pr...t..`<.001] <- "***"
s$`Pr...t..` <- format(s$`Pr...t..`, scientific=TRUE, digits=3)
s$`Pr...t..` <- as.character(s$`Pr...t..`)
s <- s %>% unite(p, c(`Pr...t..`, Significance), sep="")
options(knitr.kable.NA = '')
kable(s, digits=3, col.names=c("Coefficient", "Std. Error", "df", "t", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("hoppingcoeff.png")
```

```{r}
plot_model(hopmod, type= "pred", terms = c("TestTemp", "Photoperiod", "Temperature"), show.data=FALSE)
```
```{r}
plot_model(hopmod, type= "pred", terms = c("Temperature", "Photoperiod"), show.data=FALSE)
plot_model(hopmod, type= "pred", terms = c("Photoperiod", "Temperature"), show.data=FALSE)
```

## Feeding (shows choosing a model)
```{r}
# LmerF0 <- lmer(Tot_Consumed_scaled ~ poly(TestTemp, 2, raw = TRUE) * Sex * Site * Temperature * Photoperiod + 
#                  (1|Mom/ID), 
#                REML = FALSE,
#                na.action = 'na.omit', data = FeedPLmass) 

LmerF1 <- lmer(Tot_Consumed_scaled ~ TestTemp * Sex * Site * Temperature * Photoperiod + 
                 (1|Mom/ID), 
               na.action = 'na.omit', #uncommented
               REML = FALSE,
               data = FeedPLmass) 

LmerF2 <- lmer(Tot_Consumed_scaled ~ (TestTemp + Sex + Site + Temperature + Photoperiod)^4 + 
                 (1|Mom/ID), 
               REML = FALSE,
               na.action = 'na.omit', data = FeedPLmass) 

LmerF2.1 <- lmer(Tot_Consumed_scaled ~ (TestTemp + Sex + Site + Temperature + Photoperiod)^4 - TestTemp:Sex:Temperature:Photoperiod - TestTemp:Sex:Site:Photoperiod + 
                   (1|Mom/ID), 
                 REML = FALSE,
                 na.action = 'na.omit', data = FeedPLmass) 

LmerF3 <- lmer(Tot_Consumed_scaled ~ (TestTemp + Sex + Site + Temperature + Photoperiod)^3 + 
                 (1|Mom/ID), 
               REML = FALSE,
               na.action = 'na.omit', data = FeedPLmass) 

LmerF3.1 <- lmer(Tot_Consumed_scaled ~ (TestTemp + Sex + Site + Temperature + Photoperiod)^3 +Sex:Temperature:Photoperiod:Site + 
                   (1|Mom/ID), 
                 REML = FALSE,
                 na.action = 'na.omit', data = FeedPLmass)

LmerF3.2 <- lmer(Tot_Consumed_scaled ~ (TestTemp + Sex + Site + Temperature + Photoperiod)^2 + TestTemp:Sex:Site + TestTemp:Sex:Temperature + 
                   (1|Mom/ID), 
                 REML = FALSE,
                 na.action = 'na.omit', data = FeedPLmass)

# LmerF3.5 <- lmer(Tot_Consumed_scaled ~ (poly(TestTemp, 2, raw = TRUE) + Sex + Site + Temperature + Photoperiod)^2 + TestTemp:Sex:Site + TestTemp:Sex:Temperature + 
#                    (1|Mom/ID), 
#                  REML = FALSE, #I un-commented this
#                  na.action = 'na.omit', data = FeedPLmass) 
#^fixed-effect model matrix is rank deficient so dropping 5 columns / coefficients
#seems it's not too concerning tho https://stackoverflow.com/questions/37090722/lme4lmer-reports-fixed-effect-model-matrix-is-rank-deficient-do-i-need-a-fi

LmerF3.3 <- lmer(Tot_Consumed_scaled ~ (TestTemp + Sex + Site + Temperature + Photoperiod)^2 + TestTemp:Sex:Site + 
                   (1|Mom/ID), 
                 REML = FALSE,
                 na.action = 'na.omit', data = FeedPLmass)

LmerF3.4 <- lmer(Tot_Consumed_scaled ~ (TestTemp + Sex + Site + Temperature + Photoperiod)^2 + TestTemp:Sex:Site - TestTemp:Photoperiod + 
                   (1|Mom/ID), 
                 REML = FALSE,
                 na.action = 'na.omit', data = FeedPLmass)

LmerF4 <- lmer(Tot_Consumed_scaled ~ (TestTemp + Sex + Site + Temperature + Photoperiod)^2 + 
                 (1|Mom/ID), 
               REML = FALSE,
               na.action = 'na.omit', data = FeedPLmass)

LmerF4.1 <- lmer(Tot_Consumed_scaled ~ (TestTemp + Sex + Site + Temperature + Photoperiod)^2 + Site:Temperature:Photoperiod + 
                   (1|Mom/ID), 
                 REML = FALSE,
                 na.action = 'na.omit', data = FeedPLmass)

LmerF4.2 <- lmer(Tot_Consumed_scaled ~ (TestTemp + Sex + Site + Temperature + Photoperiod)^2 - Temperature:Photoperiod + 
                   (1|Mom/ID), 
                 REML = FALSE,
                 na.action = 'na.omit', data = FeedPLmass)

LmerF5 <- lmer(Tot_Consumed_scaled ~ TestTemp + Sex + Site + Temperature + Photoperiod + 
                 (1|Mom/ID), 
               REML = FALSE,
               na.action = 'na.omit', data = FeedPLmass)

#AIC comparisons should be done on models with "REML = FALSE"
aictab(list(LmerF1, LmerF2, LmerF2.1, LmerF3, LmerF3.1, LmerF3.2, LmerF3.3, LmerF3.4,  LmerF4, LmerF4.1, LmerF4.2, LmerF5), modnames = c("LmerF1", "LmerF2", "LmerF2.1", "LmerF3", "Lmer3.1", "Lmer3.2", "Lmer3.3", "Lmer3.4", "LmerF4", "LmerF4.1", "LmerF4.2", "LmerF5")) #LmerF1 is supported by far #something Rory said that I don't understand

#singular fit warnings

#why does he say 3.2 is selected when 3.5 appears higher? -- ah it's bc polynomial for 3 point is wrong

feedmod <- LmerF1

```

```{r}
a <- Anova(LmerF3.4, type=3)
a$Significance <- "   "
a$Significance[a$`Pr(>Chisq)`<.05] <- "*  "
a$Significance[a$`Pr(>Chisq)`<.001] <- "***"
a$`Pr(>Chisq)` <- format(a$`Pr(>Chisq)`, scientific=TRUE, digits=3)
a$`Pr(>Chisq)` <- as.character(a$`Pr(>Chisq)`)
a <- a %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
options(knitr.kable.NA = '')
kable(a, digits=3, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() #%>% save_kable("feedinganovasimple.png")
```


## Table 4: Performance anova
```{r}
hopanova <- Anova(hopmod, type=3)
hopanova$Significance <- "   "
hopanova$Significance[hopanova$`Pr(>Chisq)`<.05] <- "*  "
hopanova$Significance[hopanova$`Pr(>Chisq)`<.001] <- "***"
hopanova$`Pr(>Chisq)` <- format(hopanova$`Pr(>Chisq)`, scientific=TRUE, digits=3)
hopanova$`Pr(>Chisq)` <- as.character(hopanova$`Pr(>Chisq)`)
hopanova <- hopanova %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")
rownames(hopanova) <- rownames(hopanova) %>% str_replace("poly", "f") %>% str_remove(", 2, raw = TRUE")


feedanova <- Anova(feedmod, type=3)
rownames(feedanova) <- c()
feedanova$Significance <- "   "
feedanova$Significance[feedanova$`Pr(>Chisq)`<.05] <- "*  "
feedanova$Significance[feedanova$`Pr(>Chisq)`<.001] <- "***"
feedanova$`Pr(>Chisq)` <- format(feedanova$`Pr(>Chisq)`, scientific=TRUE, digits=3)
feedanova$`Pr(>Chisq)` <- as.character(feedanova$`Pr(>Chisq)`)
feedanova <- feedanova %>% unite(p, c(`Pr(>Chisq)`, Significance), sep="")

perfanova <- cbind(hopanova, feedanova)

options(knitr.kable.NA = '')
kable(perfanova, digits=1, col.names=c("<var>&chi;<sup>2</sup></var>", "df", "p","<var>&chi;<sup>2</sup></var>", "df", "p"), escape=FALSE, format="html") %>% kable_styling() %>% add_header_above(c(" " = 1, "Hopping distance" = 3, "Leaf area consumed" = 3)) #%>% save_kable("Tables/Tab4_perfanova.png")


```
## Table S5: Peformance Coefficients
```{r}
hopcoeff <- summary(hopmod)
hopcoeff <- data.frame(hopcoeff[["coefficients"]])
hopcoeff$Significance <- "   "
hopcoeff$Significance[hopcoeff$`Pr...t..`<.05] <- "*  "
hopcoeff$Significance[hopcoeff$`Pr...t..`<.001] <- "***"
hopcoeff$`Pr...t..` <- format(hopcoeff$`Pr...t..`, scientific=TRUE, digits=3)
hopcoeff$`Pr...t..` <- as.character(hopcoeff$`Pr...t..`)
hopcoeff <- hopcoeff %>% unite(p, c(`Pr...t..`, Significance), sep="")
rownames(hopcoeff) <- rownames(hopcoeff) %>% str_remove_all(paste(c("Sex", "Temperature", "Photoperiod", "Site"), collapse = "|")) %>% str_replace("S", "Short") %>% str_replace("poly\\(TestTemp, 2, raw = TRUE\\)1", "TestTemp") %>% str_replace("poly\\(TestTemp, 2, raw = TRUE\\)2", "TestTemp²")
#shorter alternative is get rid of current str_replaces and add str_replace("Male", "M")
kable(hopcoeff, digits=1, ccol.names=c("Coefficient", "Std. Error", "t", "p"), escape=FALSE, format="html") %>% kable_styling()

feedcoeff <- summary(feedmod)
feedcoeff <- data.frame(feedcoeff[["coefficients"]])
feedcoeff$Significance <- "   "
feedcoeff$Significance[feedcoeff$`Pr...t..`<.05] <- "*  "
feedcoeff$Significance[feedcoeff$`Pr...t..`<.001] <- "***"
feedcoeff$`Pr...t..` <- format(feedcoeff$`Pr...t..`, scientific=TRUE, digits=3)
feedcoeff$`Pr...t..` <- as.character(feedcoeff$`Pr...t..`)
feedcoeff <- feedcoeff %>% unite(p, c(`Pr...t..`, Significance), sep="")
rownames(feedcoeff) <- rownames(feedcoeff) %>% str_remove_all(paste(c("Sex", "Temperature", "Photoperiod", "Site"), collapse = "|")) %>% str_replace("S", "Short") %>% str_replace("poly\\(TestTemp, 2, raw = TRUE\\)1", "TestTemp")

perfcoeff <- merge(hopcoeff, feedcoeff, by="row.names", all=TRUE)
perfcoeff <- transform(perfcoeff[match(rownames(hopcoeff), perfcoeff$Row.names),], row.names=Row.names, Row.names=NULL)
#perfcoeff
options(knitr.kable.NA = '')
kable(perfcoeff, digits=3, col.names=c("Coefficient", "Std. Error", "df", "t", "p", "Coefficient", "Std. Error", "df", "t", "p"), escape=FALSE, format="html") %>% kable_styling() %>% add_header_above(c(" " = 1, "Hopping distance (cm)" = 5, "Mass-scaled leaf area consumed (cm²/g, 8h)" = 5)) #%>% save_kable("Tables/TabS5_perfcoeff.png")

```



```{r}
plot_model(LmerF3.4, type= "pred", terms = c("TestTemp"), show.data=FALSE)
```

```{r}
plot_model(LmerF1, type= "pred", terms = c("TestTemp"), show.data=FALSE)
```

```{r}
plot_model(LmerF3.4, type= "pred", terms = c("TestTemp","Temperature"), show.data=FALSE)
```

```{r}
plot_model(LmerF1, type= "pred", terms = c("TestTemp","Temperature"), show.data=FALSE)
```

```{r}
plot_model(LmerF3.4, type= "pred", terms = c("Site","Temperature"), show.data=FALSE)
```

```{r}
plot_model(LmerF1, type= "pred", terms = c("Site","Temperature"), show.data=FALSE)
```

```{r}
plot_model(LmerF3.4, type= "pred", terms = c("TestTemp", "Sex", "Site"), show.data=FALSE)
```

```{r}
plot_model(LmerF1, type= "pred", terms = c("TestTemp", "Sex", "Site"), show.data=FALSE)
```

```{r}

plot_model(LmerF1, type= "pred", terms = c("TestTemp", "Temperature", "Photoperiod", "Site"), show.data=FALSE)

```

